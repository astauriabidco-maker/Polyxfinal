-- ===========================================================================\n-- MIGRATION: Multi-Membership Architecture\n-- ===========================================================================\n-- Cette migration transforme le modèle User en version agnostique et crée\n-- le modèle Membership pour gérer les relations User <-> Organization.\n\n-- ===========================================================================\n-- ÉTAPE 1: Créer la table Membership\n-- ===========================================================================\nCREATE TABLE \"Membership\" (\n    \"userId\" TEXT NOT NULL,\n    \"organizationId\" TEXT NOT NULL,\n    \"role\" \"Role\" NOT NULL DEFAULT 'FORMAT',\n    \"siteId\" TEXT,\n    \"lastAccessedAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \"isActive\" BOOLEAN NOT NULL DEFAULT true,\n    \"createdAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \"updatedAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT \"Membership_pkey\" PRIMARY KEY (\"userId\",\"organizationId\")\n);\n\n-- ===========================================================================\n-- ÉTAPE 2: Migrer les données existantes vers Membership\n-- ===========================================================================\n-- Créer un Membership pour chaque User existant basé sur ses champs actuels\nINSERT INTO \"Membership\" (\"userId\", \"organizationId\", \"role\", \"siteId\", \"lastAccessedAt\", \"isActive\", \"createdAt\", \"updatedAt\")\nSELECT \n    u.\"id\" AS \"userId\",\n    u.\"organizationId\",\n    u.\"role\",\n    u.\"siteId\",\n    NOW(),\n    u.\"isActive\",\n    u.\"createdAt\",\n    u.\"updatedAt\"\nFROM \"User\" u\nWHERE u.\"organizationId\" IS NOT NULL;\n\n-- ===========================================================================\n-- ÉTAPE 3: Créer les index pour Membership\n-- ===========================================================================\nCREATE INDEX \"Membership_userId_idx\" ON \"Membership\"(\"userId\");\nCREATE INDEX \"Membership_organizationId_idx\" ON \"Membership\"(\"organizationId\");\nCREATE INDEX \"Membership_siteId_idx\" ON \"Membership\"(\"siteId\");\n\n-- ===========================================================================\n-- ÉTAPE 4: Ajouter les foreign keys à Membership\n-- ===========================================================================\nALTER TABLE \"Membership\" ADD CONSTRAINT \"Membership_userId_fkey\" \n    FOREIGN KEY (\"userId\") REFERENCES \"User\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE;\n\nALTER TABLE \"Membership\" ADD CONSTRAINT \"Membership_organizationId_fkey\" \n    FOREIGN KEY (\"organizationId\") REFERENCES \"Organization\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE;\n\nALTER TABLE \"Membership\" ADD CONSTRAINT \"Membership_siteId_fkey\" \n    FOREIGN KEY (\"siteId\") REFERENCES \"Site\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;\n\n-- ===========================================================================\n-- ÉTAPE 5: Supprimer les anciennes contraintes et colonnes de User\n-- ===========================================================================\n-- Drop foreign keys\nALTER TABLE \"User\" DROP CONSTRAINT IF EXISTS \"User_organizationId_fkey\";\nALTER TABLE \"User\" DROP CONSTRAINT IF EXISTS \"User_siteId_fkey\";\n\n-- Drop indexes\nDROP INDEX IF EXISTS \"User_organizationId_idx\";\nDROP INDEX IF EXISTS \"User_role_idx\";\nDROP INDEX IF EXISTS \"User_siteId_idx\";\n\n-- Drop columns (les données sont maintenant dans Membership)\nALTER TABLE \"User\" DROP COLUMN IF EXISTS \"organizationId\";\nALTER TABLE \"User\" DROP COLUMN IF EXISTS \"role\";\nALTER TABLE \"User\" DROP COLUMN IF EXISTS \"siteId\";\n
