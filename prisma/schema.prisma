// ===========================================================================
// ERP FORMATION - SCH√âMA PRISMA "COMPLIANCE BY DESIGN"
// ===========================================================================
// Ce sch√©ma impl√©mente les contraintes du CdCF et de la matrice RBAC.
// Toute modification doit √™tre valid√©e par le Responsable Qualit√©.
// ===========================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================================================
// ENUMS - Align√©s sur rbac_matrix.md et cdcf_functional.md
// ===========================================================================

/// R√¥les syst√®me RBAC (5 r√¥les d√©finis dans rbac_matrix.md)
enum Role {
  ADMIN        // Super Admin : DSI ou G√©rant (Acc√®s technique total mais trac√©)
  RESP_PEDAGO  // Responsable P√©dagogique : Garant contenu et certification Qualiopi
  RESP_ADMIN   // Responsable Admin/Financier : Facturation, contrats, financeurs
  REF_QUALITE  // R√©f√©rent Qualit√© : Processus, r√©clamations, veto
  FORMAT       // Formateur : Acc√®s terrain restreint √† ses sessions
}

/// Statut de phase (Machine √† √©tat pour Compliance Gates)
enum PhaseStatus {
  BROUILLON              // En cours de cr√©ation
  EN_ATTENTE_VALIDATION  // Soumis pour validation
  ACTIF                  // Valid√© et op√©rationnel
  SUSPENDU               // Temporairement bloqu√©
  CLOTURE                // Termin√© avec succ√®s
  ABANDONNE              // Arr√™t d√©finitif (motif requis)
}

/// Type de financeur (L.6353-1)
enum TypeFinanceur {
  CPF          // Mon Compte Formation (D√©lai r√©tractation 11j)
  OPCO         // Op√©rateur de Comp√©tences
  ENTREPRISE   // Plan de formation entreprise
  PERSONNEL    // Financement personnel
  MIXTE        // Combinaison de financements
}

/// Type de contrat
enum TypeContrat {
  CONVENTION   // B2B (Entreprise/OPCO)
  CONTRAT      // B2C (Particulier)
}

/// Type de preuve (Documents Qualiopi)
enum TypePreuve {
  PROGRAMME              // Programme de formation dat√©
  CGV                    // Conditions G√©n√©rales de Vente
  TEST_POSITIONNEMENT    // Test de positionnement rempli
  ANALYSE_BESOIN         // Analyse du besoin
  CONTRAT_SIGNE          // Contrat/Convention sign√©(e)
  ACCORD_FINANCEMENT     // Accord de prise en charge
  EMARGEMENT             // Feuille d'√©margement
  RELEVE_CONNEXION       // Logs FOAD
  TRAVAUX_STAGIAIRE      // Productions du stagiaire
  CERTIFICAT_REALISATION // Certificat de r√©alisation
  EVALUATION_CHAUD       // √âvaluation √† chaud
  FACTURE                // Facture finale
  AVENANT                // Avenant au contrat
  JUSTIFICATIF_ABSENCE   // Justificatif d'absence valid√©
}

/// Motif d'abandon (Machine √† √©tat Phase 4)
enum MotifAbandon {
  FORCE_MAJEURE     // Maladie, d√©c√®s, etc. (Justificatif requis)
  VOLONTAIRE        // D√©cision du stagiaire
  EXCLUSION         // D√©cision de l'organisme
  DEFAUT_PAIEMENT   // Non-paiement
}

/// Statut certification RNCP/RS
enum StatutCertification {
  ACTIVE    // Certification valide
  INACTIVE  // Certification expir√©e
  EN_COURS  // Demande en cours
}

/// Modalit√© de formation
enum Modalite {
  PRESENTIEL  // Formation en pr√©sentiel
  FOAD        // Formation √† distance
  MIXTE       // Blended learning
}

/// Niveau d'action pour AuditLog
enum NiveauAction {
  LECTURE      // Consultation (üëÅÔ∏è)
  EDITION      // Modification (‚úèÔ∏è)
  VALIDATION   // Compliance Gate (‚úÖ)
  FORCAGE      // Contournement r√®gle (üõ°Ô∏è)
}

/// Scope d'acc√®s aux sites dans une organisation
enum MembershipScope {
  GLOBAL      // Acc√®s √† TOUS les sites de l'organisation
  RESTRICTED  // Acc√®s limit√© aux sites de la relation siteAccess
}

/// Type d'organisme de formation (SaaS Multi-Tenant)
enum OrganizationType {
  OF_STANDARD  // Organisme de Formation classique
  CFA          // Centre de Formation d'Apprentis (Contrat d'apprentissage)
  BILAN        // Centre de Bilan de Comp√©tences
  VAE          // Centre de Validation des Acquis de l'Exp√©rience
}

// ===========================================================================
// MULTI-TENANT : ORGANISATION (Cloison SaaS)
// ===========================================================================

/// Organisation (OF/CFA) - Tenant principal pour l'isolation des donn√©es
model Organization {
  id                  String            @id @default(cuid())
  
  // Identit√© l√©gale
  name                String
  siret               String            @unique
  type                OrganizationType  @default(OF_STANDARD)
  responsableName     String?           // Nom du dirigeant ou responsable p√©dagogique
  
  // R√©glementaire
  ndaNumber           String?           // Num√©ro de D√©claration d'Activit√© (L.6351-1)
  qualiopiCertified   Boolean           @default(false)
  qualiopiExpiry      DateTime?         // Date d'expiration certification Qualiopi
  
  // Branding / Identit√© Visuelle
  logoUrl             String?           // Logo de l'organisation
  signatureUrl        String?           // Signature √©lectronique
  cachetUrl           String?           // Cachet de l'organisation
  
  // Documents Obligatoires
  cgvUrl              String?           // Conditions G√©n√©rales de Vente (PDF)
  livretAccueilUrl    String?           // Livret d'accueil stagiaires (PDF)
  reglementInterieurUrl String?         // R√®glement int√©rieur (PDF)
  
  // Statut
  isActive            Boolean           @default(true)
  
  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  // Relations (Tenant Isolation)
  members             Membership[]      // Utilisateurs membres de l'org
  sites               Site[]            // Multi-Site (Campus)
  programmes          Programme[]
  sessions            Session[]
  dossiers            Dossier[]
  financeurs          Financeur[]
  certifications      Certification[]
  reclamations        Reclamation[]
  companies           Company[]
  auditLogs           AuditLog[]
  preuves             Preuve[]
  
  @@index([siret])
  @@index([type])
  @@index([isActive])
}

/// Site / Campus (Lieu d'ex√©cution de formation)
model Site {
  id              String        @id @default(cuid())
  
  // Parent Organization (Tenant)
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])
  
  // Identit√©
  name            String        // Ex: "Campus Paris", "Si√®ge Lyon"
  isHeadquarters  Boolean       @default(false) // Site principal (si√®ge)
  
  // Adresse
  address         String?
  city            String
  zipCode         String
  
  // R√©glementaire CFA (Code UAI - Obligatoire si org.type = CFA)
  uaiCode         String?       // Ex: "0750001A" (8 caract√®res)
  
  // R√©glementaire OF (5 derniers chiffres SIRET - NIC)
  siretNic        String?       // Ex: "00012"
  
  // Statut
  isActive        Boolean       @default(true)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  membershipSiteAccess MembershipSiteAccess[]  // Acc√®s des membres √† ce site
  sessions             Session[]
  dossiers             Dossier[]
  
  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([uaiCode])
  @@index([isActive])
}

/// Entreprise cliente (B2B / Employeur pour CFA)
model Company {
  id              String        @id @default(cuid())
  
  // Organisation parente (Tenant)
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])
  
  // Identit√©
  raisonSociale   String
  siret           String
  
  // Contact r√©f√©rent
  contactNom      String?
  contactEmail    String?
  contactTelephone String?
  
  // Adresse
  adresse         String?
  codePostal      String?
  ville           String?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  dossiers        Dossier[]     // Apprentis de cette entreprise
  
  @@unique([organizationId, siret])
  @@index([organizationId])
}

// ===========================================================================
// UTILISATEURS & RBAC (Multi-Membership)
// ===========================================================================

/// Utilisateur (agnostique - peut appartenir √† plusieurs organisations)
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified DateTime?
  passwordHash  String?
  
  // Profil (global, partag√© entre orgs)
  nom           String
  prenom        String
  telephone     String?
  
  // Statut global
  isActive      Boolean  @default(true)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  memberships       Membership[]     // Organisations dont l'user est membre
  auditLogs         AuditLog[]
  sessionsFormateur Session[]        @relation("SessionFormateur")
  dossiersCreated   Dossier[]        @relation("DossierCreatedBy")
  validationsGiven  Validation[]
  reclamationsOwned Reclamation[]    @relation("ReclamationOwner")
  
  @@index([email])
}

/// Membership (relation User <-> Organization avec r√¥le et scope site)
model Membership {
  // Cl√© composite
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // R√¥le dans cette organisation
  role           Role         @default(FORMAT)
  
  // Scope d'acc√®s aux sites
  scope          MembershipScope @default(GLOBAL)
  
  // Sites accessibles (Many-to-Many via table de liaison)
  siteAccess     MembershipSiteAccess[]
  
  // Tracking dernier acc√®s (pour tri r√©cent)
  lastAccessedAt DateTime     @default(now())
  
  // Statut du membership
  isActive       Boolean      @default(true)
  
  // Timestamps
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

/// Table de liaison Membership <-> Site (pour scope RESTRICTED)
model MembershipSiteAccess {
  // R√©f√©rence vers Membership (cl√© composite)
  membershipUserId  String
  membershipOrgId   String
  
  // R√©f√©rence vers Site
  siteId            String
  site              Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  // Relation vers Membership
  membership        Membership  @relation(fields: [membershipUserId, membershipOrgId], references: [userId, organizationId], onDelete: Cascade)
  
  @@id([membershipUserId, membershipOrgId, siteId])
  @@index([siteId])
}

// ===========================================================================
// PHASE 1 : CATALOGUE & OFFRES
// ===========================================================================

/// Certification RNCP/RS (Check API France Comp√©tences)
model Certification {
  id              String              @id @default(cuid())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  code            String  // Ex: RNCP12345 (unique par org)
  intitule        String
  statut          StatutCertification @default(ACTIVE)
  dateFinValidite DateTime?
  
  // M√©tadonn√©es API France Comp√©tences
  urlFicheFC      String?  // URL fiche France Comp√©tences
  lastCheckedAt   DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  programmes      Programme[]
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([statut])
}

/// Programme de formation (Versionn√©)
model Programme {
  id                String        @id @default(cuid())
  
  // Tenant Isolation
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id])
  
  // Identifiant interne
  reference         String  // Ex: FORM-2024-001 (unique par org)
  
  // Contenu obligatoire (sinon blocage publication)
  intitule          String
  objectifs         String        // Texte riche
  prerequis         String        // Texte riche  
  contenu           String        // Texte riche (Programme d√©taill√©)
  modalitesEval     String        // Modalit√©s d'√©valuation
  moyensPedago      String        // Moyens p√©dagogiques
  
  // Accessibilit√© PSH
  accessibilitePSH  String?
  
  // Param√®tres
  dureeHeures       Int
  modalite          Modalite      @default(PRESENTIEL)
  tarifHT           Decimal       @db.Decimal(10, 2)
  tarifTTC          Decimal       @db.Decimal(10, 2)
  
  // Certification li√©e
  certificationId   String?
  certification     Certification? @relation(fields: [certificationId], references: [id])
  
  // Versionning (Snapshot √† la signature)
  version           Int           @default(1)
  isPublished       Boolean       @default(false)
  publishedAt       DateTime?
  
  // Statut
  status            PhaseStatus   @default(BROUILLON)
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  sessions          Session[]
  snapshots         ProgrammeSnapshot[]
  preuves           Preuve[]
  
  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([status, isPublished])
}

/// Snapshot immuable du programme (li√© au contrat sign√©)
model ProgrammeSnapshot {
  id              String   @id @default(cuid())
  programmeId     String
  programme       Programme @relation(fields: [programmeId], references: [id])
  
  version         Int
  contenuSnapshot Json     // Copie int√©grale du programme √† date
  
  createdAt       DateTime @default(now())
  
  // Relations
  contrats        Contrat[]
  
  @@unique([programmeId, version])
  @@index([programmeId])
}

// ===========================================================================
// SESSION DE FORMATION
// ===========================================================================

model Session {
  id              String      @id @default(cuid())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  // Site d'ex√©cution (OBLIGATOIRE)
  siteId          String
  site            Site         @relation(fields: [siteId], references: [id])
  
  // Programme li√©
  programmeId     String
  programme       Programme   @relation(fields: [programmeId], references: [id])
  
  // Planning
  reference       String  // Ex: SESS-2024-001 (unique par org)
  dateDebut       DateTime
  dateFin         DateTime
  lieuFormation   String?     // Adresse ou "FOAD"
  
  // Capacit√©
  placesMin       Int         @default(1)
  placesMax       Int
  
  // Formateur principal
  formateurId     String?
  formateur       User?       @relation("SessionFormateur", fields: [formateurId], references: [id])
  
  // Statut
  status          PhaseStatus @default(BROUILLON)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  dossiers        Dossier[]
  emargements     Emargement[]
  
  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([siteId])
  @@index([programmeId])
  @@index([dateDebut, dateFin])
  @@index([status])
}

// ===========================================================================
// PHASE 2 : ADMISSION
// ===========================================================================

/// Dossier stagiaire (Inscription √† une session)
model Dossier {
  id                  String      @id @default(cuid())
  
  // Tenant Isolation
  organizationId      String
  organization        Organization @relation(fields: [organizationId], references: [id])
  
  // Site d'ex√©cution (OBLIGATOIRE)
  siteId              String
  site                Site         @relation(fields: [siteId], references: [id])
  
  // Session li√©e
  sessionId           String
  session             Session     @relation(fields: [sessionId], references: [id])
  
  // Entreprise employeur (CFA / B2B)
  companyId           String?
  company             Company?    @relation(fields: [companyId], references: [id])
  tutorName           String?     // Ma√Ætre d'apprentissage (CFA)
  
  // Stagiaire
  stagiaireNom        String
  stagiairePrenom     String
  stagiaireEmail      String
  stagiaireTelephone  String?
  stagiaireAdresse    String?
  
  // Positionnement (Phase 2)
  testPositionnementEnvoye    Boolean   @default(false)
  testPositionnementComplete  Boolean   @default(false)
  scorePositionnement         Int?      // 0-100
  seuilScoreMinimum          Int       @default(50)
  alertePedagogiqueActive    Boolean   @default(false)
  
  // PSH - D√©claration obligatoire
  declarationPSH              Boolean?  // null = non renseign√© (BLOQUANT)
  adaptationsPSH              String?   // Si oui, d√©tails
  adaptationsPSHValidees      Boolean   @default(false)
  
  // Phase courante
  phaseActuelle               Int       @default(2)  // 1-5
  status                      PhaseStatus @default(BROUILLON)
  
  // Dates cl√©s
  dateInscription             DateTime  @default(now())
  dateValidationAdmission     DateTime?
  dateDebutEffectif           DateTime?
  dateFinEffective            DateTime?
  
  // Abandon (Machine √† √©tat Phase 4)
  isAbandonne                 Boolean   @default(false)
  motifAbandon                MotifAbandon?
  dateAbandon                 DateTime?
  abandonValidePedago         Boolean   @default(false)
  abandonValideAdmin          Boolean   @default(false)
  
  // Assiduit√© (Phase 4)
  tauxAssiduite               Decimal   @default(0) @db.Decimal(5, 2)  // 0.00 - 100.00
  
  // Cl√¥ture (Phase 5)
  certificatGenere            Boolean   @default(false)
  dateCertificat              DateTime?
  factureGeneree              Boolean   @default(false)
  dateFacture                 DateTime?
  
  // Cr√©ateur
  createdById                 String
  createdBy                   User      @relation("DossierCreatedBy", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  
  // Relations
  contrats                    Contrat[]
  emargements                 Emargement[]
  preuves                     Preuve[]
  evaluations                 Evaluation[]
  complianceAlerts            ComplianceAlert[]
  
  @@index([organizationId])
  @@index([siteId])
  @@index([sessionId])
  @@index([companyId])
  @@index([stagiaireEmail])
  @@index([status, phaseActuelle])
}

// ===========================================================================
// PHASE 3 : CONTRACTUALISATION
// ===========================================================================

/// Financeur
model Financeur {
  id              String        @id @default(cuid())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  type            TypeFinanceur
  
  // Identifiants
  raisonSociale   String?       // Pour OPCO/Entreprise
  siret           String?
  codeOPCO        String?       // Code OPCO si applicable
  
  // Pour CPF
  numeroCPF       String?       // Num√©ro de dossier CPF
  soldeCPF        Decimal?      @db.Decimal(10, 2)
  
  // Contact
  contactNom      String?
  contactEmail    String?
  contactTelephone String?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  contrats        Contrat[]
  
  @@index([organizationId])
  @@index([type])
  @@index([siret])
}

/// Contrat ou Convention
model Contrat {
  id                    String        @id @default(cuid())
  
  // Dossier li√©
  dossierId             String
  dossier               Dossier       @relation(fields: [dossierId], references: [id])
  
  // Type (B2B=Convention, B2C=Contrat)
  type                  TypeContrat
  
  // Snapshot programme (Versionning obligatoire)
  programmeSnapshotId   String
  programmeSnapshot     ProgrammeSnapshot @relation(fields: [programmeSnapshotId], references: [id])
  
  // Financement
  financeurId           String
  financeur             Financeur     @relation(fields: [financeurId], references: [id])
  
  // Montants
  montantHT             Decimal       @db.Decimal(10, 2)
  montantTVA            Decimal       @db.Decimal(10, 2)
  montantTTC            Decimal       @db.Decimal(10, 2)
  
  // Dates (Compliance Gate CPF)
  dateSignature         DateTime?
  dateDebutPrevue       DateTime
  dateFinPrevue         DateTime
  
  // D√©lai r√©tractation CPF (11 jours ouvr√©s)
  delaiRetractationJours Int?         // Calcul√© automatiquement si CPF
  dateFinRetractation   DateTime?     // = dateSignature + 11 jours ouvr√©s
  retractationRespectee Boolean       @default(false)
  
  // Validation financement (RESP_ADMIN)
  accordFinancementRecu Boolean       @default(false)
  dateAccordFinancement DateTime?
  referenceAccord       String?       // N¬∞ accord OPCO ou CPF
  
  // Statut
  isSigned              Boolean       @default(false)
  status                PhaseStatus   @default(BROUILLON)
  
  // Mentions l√©gales L.6353-1
  mentionsLegalesIncluses Boolean     @default(true)
  
  // Timestamps
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  // Relations
  preuves               Preuve[]
  avenants              Avenant[]
  
  @@index([dossierId])
  @@index([financeurId])
  @@index([status])
}

/// Avenant (Modification apr√®s signature - Trac√©e)
model Avenant {
  id              String   @id @default(cuid())
  
  contratId       String
  contrat         Contrat  @relation(fields: [contratId], references: [id])
  
  // Modification
  motif           String
  ancienneValeur  Json     // Snapshot avant modification
  nouvelleValeur  Json     // Nouvelle valeur
  
  // Validation
  validePar       String   // UserId (RESP_ADMIN ou ADMIN)
  dateValidation  DateTime @default(now())
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([contratId])
}

// ===========================================================================
// PHASE 4 : D√âROULEMENT
// ===========================================================================

/// √âmargement (Suivi assiduit√© par demi-journ√©e)
model Emargement {
  id              String   @id @default(cuid())
  
  // Session et Dossier li√©s
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id])
  dossierId       String
  dossier         Dossier  @relation(fields: [dossierId], references: [id])
  
  // Date et cr√©neau
  dateEmargement  DateTime
  demiJournee     String   // "MATIN" ou "APRES_MIDI"
  
  // Pr√©sence
  estPresent      Boolean  @default(false)
  
  // Signature (Base64 ou r√©f√©rence fichier)
  signatureStagiaire String?
  signatureFormateur String?
  
  // Justificatif absence
  absenceJustifiee Boolean @default(false)
  motifAbsence     String?
  justificatifPath String?  // Chemin vers le document upload√©
  justificatifValide Boolean @default(false)
  
  // Logs FOAD (si formation √† distance)
  isFOAD          Boolean  @default(false)
  tempsConnexion  Int?     // En minutes
  jalonAtteint    Boolean  @default(false)
  
  // For√ßage date (ADMIN uniquement - Alerte REF_QUALITE)
  dateOriginale   DateTime? // Si modification r√©troactive
  isForced        Boolean   @default(false)
  forcedById      String?
  forcedReason    String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([sessionId, dossierId, dateEmargement, demiJournee])
  @@index([sessionId])
  @@index([dossierId])
  @@index([dateEmargement])
}

/// Alerte d√©crochage
model AlerteDecrochage {
  id              String   @id @default(cuid())
  
  dossierId       String
  sessionId       String
  
  // D√©clencheur
  type            String   // "ABSENCE_CONSECUTIVE", "SCORE_BAS", "INACTIVITE_FOAD"
  description     String
  
  // Traitement
  isTraitee       Boolean  @default(false)
  dateTraitement  DateTime?
  actionPrise     String?
  traiteParId     String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([dossierId])
  @@index([isTraitee])
}

// ===========================================================================
// PHASE 5 : CL√îTURE & PREUVES
// ===========================================================================

/// √âvaluation (R√©sultats et √©valuations √† chaud)
model Evaluation {
  id              String   @id @default(cuid())
  
  dossierId       String
  dossier         Dossier  @relation(fields: [dossierId], references: [id])
  
  // Type
  type            String   // "ACQUIS", "SATISFACTION_CHAUD", "SATISFACTION_FROID"
  
  // Contenu
  score           Int?     // 0-100 ou note sur 10
  commentaires    String?
  reponses        Json?    // R√©ponses d√©taill√©es au questionnaire
  
  // Validation
  saisiPar        String   // UserId
  dateSaisie      DateTime @default(now())
  
  @@index([dossierId])
  @@index([type])
}

/// Preuve (Documents g√©n√©r√©s - Qualiopi)
model Preuve {
  id              String     @id @default(cuid())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  // Type de preuve
  type            TypePreuve
  
  // Entit√© li√©e (polymorphe)
  programmeId     String?
  programme       Programme? @relation(fields: [programmeId], references: [id])
  dossierId       String?
  dossier         Dossier?   @relation(fields: [dossierId], references: [id])
  contratId       String?
  contrat         Contrat?   @relation(fields: [contratId], references: [id])
  
  // Fichier
  nomFichier      String
  cheminFichier   String
  mimeType        String
  tailleFichier   Int        // En bytes
  
  // Hash int√©grit√© (SHA-256)
  hashFichier     String
  
  // Signature √©lectronique (eIDAS)
  isSigned        Boolean    @default(false)
  signatureInfo   Json?      // M√©tadonn√©es signature
  
  // M√©tadonn√©es
  dateGeneration  DateTime   @default(now())
  genereParId     String?
  
  @@index([organizationId])
  @@index([type])
  @@index([dossierId])
  @@index([contratId])
}

// ===========================================================================
// TRANSVERSE : QUALIT√â
// ===========================================================================

/// R√©clamation
model Reclamation {
  id              String      @id @default(cuid())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  // Demandeur
  demandeurType   String      // "STAGIAIRE", "ENTREPRISE", "FINANCEUR"
  demandeurNom    String
  demandeurEmail  String
  
  // Contenu
  objet           String
  description     String
  
  // Traitement (REF_QUALITE)
  ownerId         String?
  owner           User?       @relation("ReclamationOwner", fields: [ownerId], references: [id])
  
  status          PhaseStatus @default(BROUILLON)
  dateResolution  DateTime?
  actionsCorrectives String?
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([organizationId])
  @@index([status])
  @@index([ownerId])
}

/// Validation (Trace des Compliance Gates)
model Validation {
  id              String   @id @default(cuid())
  
  // Action valid√©e
  action          String   // Ex: "PUBLISH_OFFER", "VALIDATE_ADMISSION"
  entityType      String   // Ex: "Programme", "Dossier"
  entityId        String
  
  // Phase CdCF
  phase           Int      // 1-5
  
  // Valideur
  validateurId    String
  validateur      User     @relation(fields: [validateurId], references: [id])
  roleValidateur  Role
  
  // R√©sultat
  decision        String   // "APPROVED", "REJECTED", "FORCED"
  motif           String?  // Obligatoire si REJECTED ou FORCED
  
  // Timestamp immuable
  createdAt       DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([validateurId])
  @@index([phase])
}

// ===========================================================================
// MOTEUR DE R√àGLES - COMPLIANCE ALERTS
// ===========================================================================

/// @Compliance: Stocke les blocages lev√©s par le Moteur de R√®gles JSON
/// Chaque alerte r√©f√©rence un ruleId du fichier compliance_rules.json
model ComplianceAlert {
  id          String   @id @default(cuid())
  
  // Dossier concern√©
  dossierId   String
  dossier     Dossier  @relation(fields: [dossierId], references: [id])
  
  // R√©f√©rence √† la r√®gle (compliance_rules.json)
  ruleId      String   // Ex: "RULE_CPF_RETRACTATION", "RULE_CERTIF_ACTIVE"
  
  // S√©v√©rit√© (BLOCKING, REQUIRES_APPROVAL, WARNING)
  severity    String
  
  // Contexte
  context     String   // Phase CdCF: "CATALOGUE", "ADMISSION", "CONTRACTUALISATION", etc.
  trigger     String   // Action d√©clenchante: "VALIDATE_START_DATE", "PUBLISH_OFFER"
  
  // Message d'erreur
  message     String
  
  // Donn√©es contextuelles
  details     Json?    // Snapshot des donn√©es ayant d√©clench√© l'alerte
  
  // R√©solution
  isResolved   Boolean  @default(false)
  resolvedById String?
  resolvedAt   DateTime?
  resolution   String?  // Motif de r√©solution si forc√©
  
  // Timestamp immuable
  createdAt    DateTime @default(now())
  
  @@index([dossierId])
  @@index([ruleId])
  @@index([isResolved])
  @@index([severity])
}

// ===========================================================================
// AUDIT LOG (IMMUABLE - Qualiopi)
// ===========================================================================

/// Log d'audit immuable - AUCUN UPDATE/DELETE AUTORIS√â
model AuditLog {
  id              String      @id @default(cuid())
  timestamp       DateTime    @default(now())
  
  // Tenant Isolation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  // Acteur
  userId          String
  userRole        Role
  user            User        @relation(fields: [userId], references: [id])
  
  // Action (R√©f√©rence rbac_matrix.md)
  action          String      // Ex: "CREATE_PROGRAMME", "VALIDATE_ADMISSION"
  niveauAction    NiveauAction
  
  // Entit√© concern√©e
  entityType      String      // Ex: "Programme", "Dossier", "Emargement"
  entityId        String
  
  // Contexte
  phase           Int?        // Phase CdCF (1-5)
  
  // For√ßage (üõ°Ô∏è dans RBAC)
  isForced        Boolean     @default(false)
  justification   String?     // OBLIGATOIRE si isForced = true
  
  // Snapshot des donn√©es
  previousState   Json?       // √âtat avant modification
  newState        Json?       // √âtat apr√®s modification
  
  // M√©tadonn√©es techniques
  ipAddress       String?
  userAgent       String?
  requestId       String?     // Pour tra√ßabilit√© requ√™te
  
  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@index([phase])
}
