generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Organisation (OF/CFA) - Tenant principal pour l'isolation des données
model Organization {
  id                    String               @id @default(cuid())
  name                  String
  siret                 String               @unique
  type                  OrganizationType     @default(OF_STANDARD)
  ndaNumber             String?
  qualiopiCertified     Boolean              @default(false)
  qualiopiExpiry        DateTime?
  logoUrl               String?
  isActive              Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  cachetUrl             String?
  cgvUrl                String?
  leadFeeRate           Float?
  livretAccueilUrl      String?
  networkType           NetworkType?
  parentId              String?
  reglementInterieurUrl String?
  responsableName       String?
  royaltyRate           Float?
  signatureUrl          String?
  auditLogs             AuditLog[]
  campaigns             Campaign[]
  certifications        Certification[]
  companies             Company[]
  documentTemplates    DocumentTemplate[]
  dossiers              Dossier[]
  financeurs            Financeur[]
  franchiseCandidates   FranchiseCandidate[]
  leads                 Lead[]
  members               Membership[]
  networkSettings       NetworkSettings?
  parent                Organization?        @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children              Organization[]       @relation("OrganizationHierarchy")
  partners              Partner[]
  preuves               Preuve[]
  programmes            Programme[]
  reclamations          Reclamation[]
  sessions              Session[]
  sites                 Site[]
  territories           Territory[]
  roles                 Role[]

  @@index([siret])
  @@index([type])
  @@index([isActive])
  @@index([networkType])
  @@index([parentId])
}

/// Site / Campus (Lieu d'exécution de formation)
model Site {
  id                   String                 @id @default(cuid())
  organizationId       String
  name                 String
  isHeadquarters       Boolean                @default(false)
  address              String?
  city                 String
  zipCode              String
  uaiCode              String?
  siretNic             String?
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  dossiers             Dossier[]
  membershipSiteAccess MembershipSiteAccess[]
  sessions             Session[]
  organization         Organization           @relation(fields: [organizationId], references: [id])
  leads                Lead[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([uaiCode])
  @@index([isActive])
}

/// Entreprise cliente (B2B / Employeur pour CFA)
model Company {
  id               String       @id @default(cuid())
  organizationId   String
  raisonSociale    String
  siret            String
  contactNom       String?
  contactEmail     String?
  contactTelephone String?
  adresse          String?
  codePostal       String?
  ville            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id])
  dossiers         Dossier[]

  @@unique([organizationId, siret])
  @@index([organizationId])
}

/// Utilisateur (agnostique - peut appartenir à plusieurs organisations)
model User {
  id                String        @id @default(cuid())
  email             String        @unique
  emailVerified     DateTime?
  passwordHash      String?
  nom               String
  prenom            String
  telephone         String?
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  auditLogs         AuditLog[]
  dossiersCreated   Dossier[]     @relation("DossierCreatedBy")
  memberships       Membership[]
  reclamationsOwned Reclamation[] @relation("ReclamationOwner")
  sessionsFormateur Session[]     @relation("SessionFormateur")
  validationsGiven  Validation[]
  preuvesGenerated  Preuve[]      @relation("PreuveGenerePar")

  @@index([email])
}

/// Membership (relation User <-> Organization avec rôle et scope site)
model Membership {
  userId         String
  organizationId String
  roleId         String                 // Changed from role enum to roleId
  scope          MembershipScope        @default(GLOBAL)
  lastAccessedAt DateTime               @default(now())
  isActive       Boolean                @default(true)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           Role                   @relation(fields: [roleId], references: [id])
  siteAccess     MembershipSiteAccess[]

  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

/// Table de liaison Membership <-> Site (pour scope RESTRICTED)
model MembershipSiteAccess {
  membershipUserId String
  membershipOrgId  String
  siteId           String
  membership       Membership @relation(fields: [membershipUserId, membershipOrgId], references: [userId, organizationId], onDelete: Cascade)
  site             Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@id([membershipUserId, membershipOrgId, siteId])
  @@index([siteId])
}

/// Certification RNCP/RS (Check API France Compétences)
model Certification {
  id              String              @id @default(cuid())
  code            String
  intitule        String
  statut          StatutCertification @default(ACTIVE)
  dateFinValidite DateTime?
  urlFicheFC      String?
  lastCheckedAt   DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  organizationId  String
  organization    Organization        @relation(fields: [organizationId], references: [id])
  programmes      Programme[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([statut])
}

/// Programme de formation (Versionné)
model Programme {
  id               String              @id @default(cuid())
  reference        String
  intitule         String
  objectifs        String
  prerequis        String
  contenu          String
  modalitesEval    String
  moyensPedago     String
  accessibilitePSH String?
  dureeHeures      Int
  modalite         Modalite            @default(PRESENTIEL)
  tarifHT          Decimal             @db.Decimal(10, 2)
  tarifTTC         Decimal             @db.Decimal(10, 2)
  certificationId  String?
  version          Int                 @default(1)
  isPublished      Boolean             @default(false)
  publishedAt      DateTime?
  status           PhaseStatus         @default(BROUILLON)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  organizationId   String
  preuves          Preuve[]
  certification    Certification?      @relation(fields: [certificationId], references: [id])
  organization     Organization        @relation(fields: [organizationId], references: [id])
  snapshots        ProgrammeSnapshot[]
  sessions         Session[]

  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([status, isPublished])
}

/// Snapshot immuable du programme (lié au contrat signé)
model ProgrammeSnapshot {
  id              String    @id @default(cuid())
  programmeId     String
  version         Int
  contenuSnapshot Json
  createdAt       DateTime  @default(now())
  contrats        Contrat[]
  programme       Programme @relation(fields: [programmeId], references: [id])

  @@unique([programmeId, version])
  @@index([programmeId])
}

model Session {
  id             String       @id @default(cuid())
  programmeId    String
  reference      String
  dateDebut      DateTime
  dateFin        DateTime
  lieuFormation  String?
  placesMin      Int          @default(1)
  placesMax      Int
  formateurId    String?
  status         PhaseStatus  @default(BROUILLON)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  siteId         String
  dossiers       Dossier[]
  emargements    Emargement[]
  formateur      User?        @relation("SessionFormateur", fields: [formateurId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  programme      Programme    @relation(fields: [programmeId], references: [id])
  site           Site         @relation(fields: [siteId], references: [id])

  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([siteId])
  @@index([programmeId])
  @@index([dateDebut, dateFin])
  @@index([status])
}

/// Dossier stagiaire (Inscription à une session)
model Dossier {
  id                         String            @id @default(cuid())
  sessionId                  String
  stagiaireNom               String
  stagiairePrenom            String
  stagiaireEmail             String
  stagiaireTelephone         String?
  stagiaireAdresse           String?
  testPositionnementEnvoye   Boolean           @default(false)
  testPositionnementComplete Boolean           @default(false)
  scorePositionnement        Int?
  seuilScoreMinimum          Int               @default(50)
  alertePedagogiqueActive    Boolean           @default(false)
  declarationPSH             Boolean?
  adaptationsPSH             String?
  adaptationsPSHValidees     Boolean           @default(false)
  phaseActuelle              Int               @default(2)
  status                     PhaseStatus       @default(BROUILLON)
  dateInscription            DateTime          @default(now())
  dateValidationAdmission    DateTime?
  dateDebutEffectif          DateTime?
  dateFinEffective           DateTime?
  isAbandonne                Boolean           @default(false)
  motifAbandon               MotifAbandon?
  dateAbandon                DateTime?
  abandonValidePedago        Boolean           @default(false)
  abandonValideAdmin         Boolean           @default(false)
  tauxAssiduite              Decimal           @default(0) @db.Decimal(5, 2)
  certificatGenere           Boolean           @default(false)
  dateCertificat             DateTime?
  factureGeneree             Boolean           @default(false)
  dateFacture                DateTime?
  createdById                String
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  companyId                  String?
  organizationId             String
  tutorName                  String?
  siteId                     String
  dispatchedAt               DateTime?
  dispatchedFromId           String?
  originalLeadDate           DateTime?
  source                     DossierSource     @default(ORGANIC)
  stagiaireCp                String?
  complianceAlerts           ComplianceAlert[]
  contrats                   Contrat[]
  company                    Company?          @relation(fields: [companyId], references: [id])
  createdBy                  User              @relation("DossierCreatedBy", fields: [createdById], references: [id])
  organization               Organization      @relation(fields: [organizationId], references: [id])
  session                    Session           @relation(fields: [sessionId], references: [id])
  site                       Site              @relation(fields: [siteId], references: [id])
  emargements                Emargement[]
  evaluations                Evaluation[]
  preuves                    Preuve[]

  @@index([organizationId])
  @@index([siteId])
  @@index([sessionId])
  @@index([companyId])
  @@index([stagiaireEmail])
  @@index([status, phaseActuelle])
  @@index([source])
}

/// Financeur
model Financeur {
  id               String        @id @default(cuid())
  type             TypeFinanceur
  raisonSociale    String?
  siret            String?
  codeOPCO         String?
  numeroCPF        String?
  soldeCPF         Decimal?      @db.Decimal(10, 2)
  contactNom       String?
  contactEmail     String?
  contactTelephone String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  organizationId   String
  contrats         Contrat[]
  organization     Organization  @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([siret])
}

/// Contrat ou Convention
model Contrat {
  id                      String            @id @default(cuid())
  dossierId               String
  type                    TypeContrat
  programmeSnapshotId     String
  financeurId             String
  montantHT               Decimal           @db.Decimal(10, 2)
  montantTVA              Decimal           @db.Decimal(10, 2)
  montantTTC              Decimal           @db.Decimal(10, 2)
  dateSignature           DateTime?
  dateDebutPrevue         DateTime
  dateFinPrevue           DateTime
  delaiRetractationJours  Int?
  dateFinRetractation     DateTime?
  retractationRespectee   Boolean           @default(false)
  accordFinancementRecu   Boolean           @default(false)
  dateAccordFinancement   DateTime?
  referenceAccord         String?
  isSigned                Boolean           @default(false)
  status                  PhaseStatus       @default(BROUILLON)
  mentionsLegalesIncluses Boolean           @default(true)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  avenants                Avenant[]
  dossier                 Dossier           @relation(fields: [dossierId], references: [id])
  financeur               Financeur         @relation(fields: [financeurId], references: [id])
  programmeSnapshot       ProgrammeSnapshot @relation(fields: [programmeSnapshotId], references: [id])
  preuves                 Preuve[]

  @@index([dossierId])
  @@index([financeurId])
  @@index([status])
}

/// Avenant (Modification après signature - Tracée)
model Avenant {
  id             String   @id @default(cuid())
  contratId      String
  motif          String
  ancienneValeur Json
  nouvelleValeur Json
  validePar      String
  dateValidation DateTime @default(now())
  createdAt      DateTime @default(now())
  contrat        Contrat  @relation(fields: [contratId], references: [id])

  @@index([contratId])
}

/// Émargement (Suivi assiduité par demi-journée)
model Emargement {
  id                 String    @id @default(cuid())
  sessionId          String
  dossierId          String
  dateEmargement     DateTime
  demiJournee        String
  estPresent         Boolean   @default(false)
  signatureStagiaire String?
  signatureFormateur String?
  absenceJustifiee   Boolean   @default(false)
  motifAbsence       String?
  justificatifPath   String?
  justificatifValide Boolean   @default(false)
  isFOAD             Boolean   @default(false)
  tempsConnexion     Int?
  jalonAtteint       Boolean   @default(false)
  dateOriginale      DateTime?
  isForced           Boolean   @default(false)
  forcedById         String?
  forcedReason       String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  dossier            Dossier   @relation(fields: [dossierId], references: [id])
  session            Session   @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, dossierId, dateEmargement, demiJournee])
  @@index([sessionId])
  @@index([dossierId])
  @@index([dateEmargement])
}

/// Alerte décrochage
model AlerteDecrochage {
  id             String    @id @default(cuid())
  dossierId      String
  sessionId      String
  type           String
  description    String
  isTraitee      Boolean   @default(false)
  dateTraitement DateTime?
  actionPrise    String?
  traiteParId    String?
  createdAt      DateTime  @default(now())

  @@index([dossierId])
  @@index([isTraitee])
}

/// Évaluation (Résultats et évaluations à chaud)
model Evaluation {
  id           String   @id @default(cuid())
  dossierId    String
  type         String
  score        Int?
  commentaires String?
  reponses     Json?
  saisiPar     String
  dateSaisie   DateTime @default(now())
  dossier      Dossier  @relation(fields: [dossierId], references: [id])

  @@index([dossierId])
  @@index([type])
}

/// Preuve (Documents générés - Qualiopi)
model Preuve {
  id             String       @id @default(cuid())
  type           TypePreuve
  dossierId      String?
  organizationId String
  programmeId    String?
  contratId      String?
  nomFichier     String
  cheminFichier  String
  mimeType       String
  tailleFichier  Int
  hashFichier    String
  isSigned       Boolean      @default(false)
  signatureId    String?
  dateGeneration DateTime     @default(now())
  genereParId    String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  generePar      User         @relation("PreuveGenerePar", fields: [genereParId], references: [id])
  dossier        Dossier?     @relation(fields: [dossierId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  programme      Programme?   @relation(fields: [programmeId], references: [id])
  contrat        Contrat?     @relation(fields: [contratId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([dossierId])
  @@index([contratId])
}

/// Réclamation
model Reclamation {
  id                 String       @id @default(cuid())
  demandeurType      String
  demandeurNom       String
  demandeurEmail     String
  objet              String
  description        String
  ownerId            String?
  status             PhaseStatus  @default(BROUILLON)
  dateResolution     DateTime?
  actionsCorrectives String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id])
  owner              User?        @relation("ReclamationOwner", fields: [ownerId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([ownerId])
}

/// Validation (Trace des Compliance Gates)
model Validation {
  id             String   @id @default(cuid())
  action         String
  entityType     String
  entityId       String
  phase          Int
  validateurId   String
  roleValidateur String       // Snapshot of role code
  decision       String
  motif          String?
  createdAt      DateTime @default(now())
  validateur     User     @relation(fields: [validateurId], references: [id])

  @@index([entityType, entityId])
  @@index([validateurId])
  @@index([phase])
}

/// @Compliance: Stocke les blocages levés par le Moteur de Règles JSON
/// Chaque alerte référence un ruleId du fichier compliance_rules.json
model ComplianceAlert {
  id           String    @id @default(cuid())
  dossierId    String
  ruleId       String
  severity     String
  context      String
  trigger      String
  message      String
  details      Json?
  isResolved   Boolean   @default(false)
  resolvedById String?
  resolvedAt   DateTime?
  resolution   String?
  createdAt    DateTime  @default(now())
  dossier      Dossier   @relation(fields: [dossierId], references: [id])

  @@index([dossierId])
  @@index([ruleId])
  @@index([isResolved])
  @@index([severity])
}

/// Log d'audit immuable - AUCUN UPDATE/DELETE AUTORISÉ
model AuditLog {
  id             String       @id @default(cuid())
  timestamp      DateTime     @default(now())
  userId         String
  userRole       String       // Snapshot of role name/code at time of action
  action         String
  niveauAction   NiveauAction
  entityType     String
  entityId       String
  phase          Int?
  isForced       Boolean      @default(false)
  justification  String?
  previousState  Json?
  newState       Json?
  ipAddress      String?
  userAgent      String?
  requestId      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@index([phase])
}

model Campaign {
  id                  String               @id @default(cuid())
  organizationId      String
  name                String
  source              LeadSource
  externalId          String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  budget              Decimal?             @db.Decimal(10, 2)
  spent               Decimal?             @db.Decimal(10, 2)
  startDate           DateTime?
  endDate             DateTime?
  isActive            Boolean              @default(true)
  webhookSecret       String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  organization        Organization         @relation(fields: [organizationId], references: [id])
  leads               Lead[]
  franchiseCandidates FranchiseCandidate[]

  @@unique([organizationId, externalId])
  @@index([isActive])
  @@index([organizationId])
  @@index([source])
}

model CandidateActivity {
  id          String                @id @default(cuid())
  candidateId String
  type        CandidateActivityType
  description String
  metadata    Json?
  performedBy String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  candidate   FranchiseCandidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([createdAt(sort: Desc)])
  @@index([type])
}

model FranchiseCandidate {
  id                   String              @id @default(cuid())
  organizationId       String
  email                String
  phone                String?
  status               CandidateStatus     @default(NEW)
  targetZone           String?
  targetZipCodes       String[]
  investmentBudget     Decimal?            @db.Decimal(12, 2)
  dipSentAt            DateTime?
  dipSignedAt          DateTime?
  contractSignedAt     DateTime?
  createdOrgId         String?
  notes                String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  campaignId           String?
  companyName          String
  experienceScore      Int?
  financialScore       Int?
  franchiseType        FranchiseType
  geoScore             Int?
  leadSource           LeadSource          @default(WEBSITE_FORM)
  motivationIndex      Int?
  qualificationAnswers Json?
  qualificationScore   Int?
  qualifiedAt          DateTime?
  representantFonction String?
  representantNom      String
  representantPrenom   String
  siret                String?
  structureScore       Int?
  timingScore          Int?
  utmCampaign          String?
  utmMedium            String?
  utmSource            String?
  name                 String?
  activities           CandidateActivity[]
  organization         Organization        @relation(fields: [organizationId], references: [id])
  campaign             Campaign?           @relation(fields: [campaignId], references: [id])

  @@index([email])
  @@index([franchiseType])
  @@index([leadSource])
  @@index([organizationId])
  @@index([qualificationScore])
  @@index([status])
}

model Lead {
  id                 String       @id @default(cuid())
  organizationId     String
  siteId             String?      // [NEW] Dispatch: Agence/Campus responsable
  source             LeadSource
  sourceRef          String?
  campaignId         String?
  partnerId          String?
  origin             String?      // [NEW] Précision sur l'origine (ex: "Salon étudiant", "Formulaire Contact")
  email              String
  nom                String
  prenom             String
  telephone          String?
  adresse            String?          // Rue / numéro de rue
  codePostal         String?
  ville              String?
  formationSouhaitee String?
  message            String?
  dateReponse        DateTime?        // Date de réponse du lead
  dateRdv            DateTime?        // [NEW] Date du RDV physique confirmé
  metadata           Json?
  status             LeadStatus   @default(NEW)
  score              Int?
  notes              String?
  assignedToId       String?
  convertedAt        DateTime?
  convertedDossierId String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  campaign           Campaign?    @relation(fields: [campaignId], references: [id])
  organization       Organization @relation(fields: [organizationId], references: [id])
  site               Site?        @relation(fields: [siteId], references: [id]) // [NEW] Relation
  partner            Partner?     @relation(fields: [partnerId], references: [id])
  leadConsent        LeadConsent?

  @@index([campaignId])
  @@index([createdAt])
  @@index([email])
  @@index([organizationId])
  @@index([siteId]) // [NEW] Index
  @@index([partnerId])
  @@index([source])
  @@index([status])
}

model LeadConsent {
  id            String    @id @default(cuid())
  leadId        String    @unique
  consentGiven  Boolean   @default(false)
  consentText   String
  consentMethod String
  legalBasis    String
  withdrawnAt   DateTime?
  anonymizedAt  DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([consentGiven])
  @@index([leadId])
}

model NetworkSettings {
  id                       String       @id @default(cuid())
  organizationId           String       @unique
  onboardingEmailSubject   String       @default("Signature de vos contrats de partenariat - Polyx ERP")
  onboardingEmailBody      String       @db.Text
  activationEmailSubject   String       @default("Activation de votre accès API - Polyx ERP")
  activationEmailBody      String       @db.Text
  apiDocumentationMarkdown String       @db.Text
  updatedAt                DateTime     @updatedAt
  organization             Organization @relation(fields: [organizationId], references: [id])
}

/// Templates de documents juridiques configurables par organisme
model DocumentTemplate {
  id             String               @id @default(cuid())
  organizationId String
  type           DocumentTemplateType // CONTRACT, DPA, CGV
  title          String               // Titre du document (ex: "Contrat de Partenariat API")
  version        Int                  @default(1) // Numéro de version
  isActive       Boolean              @default(true) // Seul le template actif est utilisé
  sections       Json                 // Sections du document [{title, content}]
  variables      Json?                // Métadonnées sur les variables disponibles
  footerText     String?              @db.Text // Texte de pied de page
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  createdBy      String?              // userId de l'auteur

  organization   Organization         @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, type, version])
  @@index([organizationId, type, isActive])
}

model Partner {
  id             String @id @default(cuid())
  organizationId String

  // ─── Identification personne morale ─────────────────────
  companyName    String // Raison sociale
  formeJuridique String? // SAS, SARL, EURL, SA, SCI, Auto-entrepreneur...
  capitalSocial  Decimal? @db.Decimal(12, 2) // Capital social en euros
  siret          String? // SIRET 14 chiffres
  siren          String? // SIREN 9 chiffres (déduit du SIRET)
  codeNAF        String? // Code APE/NAF
  rcs            String? // RCS (ex: "RCS Paris B 123 456 789")
  tvaIntracom    String? // N° TVA intracommunautaire

  // ─── Adresse du siège social ────────────────────────────
  adresse           String? // Numéro et rue
  complementAdresse String? // Bâtiment, étage, etc.
  codePostal        String? // Code postal
  ville             String? // Ville
  pays              String  @default("France") // Pays

  // ─── Représentant légal ─────────────────────────────────
  representantNom      String? // Nom complet du représentant légal
  representantFonction String? // Fonction (Gérant, Président, DG...)

  // ─── Contact opérationnel (technique / leads) ───────────
  contactName  String // Nom du contact opérationnel
  contactEmail String // Email du contact
  contactPhone String? // Téléphone du contact

  // ─── Coordonnées bancaires (pour facturation) ──────────
  iban String? // IBAN
  bic  String? // BIC / SWIFT

  // ─── API & Technique ────────────────────────────────────
  apiKeyHash   String?  @unique // SHA-256 hash de la clé API (null tant que non activé)
  apiKeyPrefix String? // Préfixe visible (pk_live_xxxx...) (null tant que non activé)
  rateLimit    Int      @default(100) // Requêtes max / heure
  webhookUrl   String? // URL callback pour notifications
  ipWhitelist  String[] // IPs autorisées (vide = toutes)

  // ─── Contrat & Conformité ──────────────────────────────
  contractUrl       String? // URL du contrat signé
  contractSignedAt  DateTime? // Date signature contrat
  contractExpiresAt DateTime? // Date expiration contrat
  dpaSignedAt       DateTime? // Date signature DPA (RGPD)
  ndaSignedAt       DateTime? // Date signature NDA
  commissionRate    Decimal?  @db.Decimal(5, 2) // Taux commission (si applicable)
  costPerLead       Decimal?  @db.Decimal(8, 2) // Coût fixe par lead soumis (€)
  notes             String?   @db.Text // Notes internes

  // ─── Statut & Métriques ─────────────────────────────────
  status              PartnerStatus @default(PENDING)
  totalLeadsSubmitted Int           @default(0)
  totalLeadsConverted Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // ─── Relations ──────────────────────────────────────────
  leads          Lead[]
  auditLogs      PartnerAuditLog[]
  qualification  PartnerQualification?
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([apiKeyHash])
  @@index([organizationId])
  @@index([status])
  @@index([siret])
}

/// Journal d'audit des actions partenaires (Qualiopi Ind.17/26 + RGPD Art.5)
model PartnerAuditLog {
  id             String   @id @default(cuid())
  partnerId      String
  organizationId String
  action         String   // CREATED, ACTIVATED, SUSPENDED, CONTRACT_SIGNED, DPA_SIGNED, 
                          // NDA_SIGNED, API_KEY_GENERATED, API_KEY_REVOKED, RATE_LIMIT_CHANGED,
                          // CONTRACT_EXPIRED, STATUS_CHANGED, UPDATED, DELETED, LEAD_REJECTED_COMPLIANCE
  performedBy    String?  // userId de l'admin qui a effectué l'action (null = système)
  performedByName String? // Nom lisible de l'acteur
  details        String?  @db.Text // Description détaillée de l'action
  previousValue  Json?    // Snapshot avant modification
  newValue       Json?    // Snapshot après modification
  ipAddress      String?  // IP de l'admin
  userAgent      String?  // User-Agent de l'admin
  createdAt      DateTime @default(now())

  partner        Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

/// Qualification partenaire — Qualiopi Ind. 17 (sous-traitance) & Ind. 26 (intervenants externes)
/// Trace la convention de sous-traitance, la qualification du partenaire et le contrôle qualité.
model PartnerQualification {
  id             String @id @default(cuid())
  partnerId      String @unique
  organizationId String

  // ─── Convention de sous-traitance (Ind. 17) ────────────
  conventionSignedAt  DateTime?  // Date signature convention de sous-traitance
  conventionUrl       String?    // URL du document signé
  conventionExpiresAt DateTime?  // Date expiration convention
  conventionType      String     @default("PROSPECTION") // PROSPECTION, FORMATION, MIXTE

  // ─── Dossier de compétences (Ind. 26) ──────────────────
  hasKbis             Boolean @default(false) // Extrait K-Bis à jour
  hasRcPro            Boolean @default(false) // Assurance RC Professionnelle
  hasUrssaf           Boolean @default(false) // Attestation URSSAF < 6 mois
  hasReferences       Boolean @default(false) // Références clients fournies
  hasCertifications   Boolean @default(false) // Certifications/agréments
  hasQualityCharter   Boolean @default(false) // Charte qualité signée

  // ─── Champs textuels pour détails ──────────────────────
  certificationDetails String?  @db.Text // Détail des certifications (Qualiopi, ISO, etc.)
  referencesDetails    String?  @db.Text // Détail des références fournies
  rcProPolicyNumber    String?           // N° de police RC Pro
  rcProExpiresAt       DateTime?         // Expiration RC Pro
  urssafDate           DateTime?         // Date attestation URSSAF
  kbisDate             DateTime?         // Date extrait K-Bis

  // ─── Score & Évaluation ────────────────────────────────
  qualificationScore   Int      @default(0)  // Score 0-100 calculé
  qualificationGrade   String   @default("D") // A, B, C, D
  isQualified          Boolean  @default(false) // Score >= seuil minimum (60)
  lastEvaluationAt     DateTime?             // Date dernière évaluation
  nextReviewAt         DateTime?             // Date prochaine revue programmée
  evaluatedBy          String?               // Nom de l'évaluateur
  evaluationNotes      String?  @db.Text     // Notes de l'évaluation

  // ─── Timestamps ────────────────────────────────────────
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ─── Relations ─────────────────────────────────────────
  partner      Partner      @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isQualified])
  @@index([qualificationGrade])
  @@index([nextReviewAt])
}

model Territory {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  zipCodes       String[]
  isExclusive    Boolean      @default(true)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([isActive])
  @@index([organizationId])
}

/// Rôles système RBAC (5 rôles définis dans rbac_matrix.md)
/// Role (Système RBAC Dynamique)
model Role {
  id             String           @id @default(cuid())
  name           String           // ex: "Responsable Pédagogique"
  code           String           // ex: "RESP_PEDAGO"
  description    String?
  isSystem       Boolean          @default(false)
  organizationId String?          // Null = Global System Role, Value = Custom Org Role
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  permissions    RolePermission[]
  memberships    Membership[]

  organization   Organization?    @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@unique([organizationId, code])
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique // ex: "org:read", "dossier:create"
  description String
  category    String?          // ex: "Dossiers", "Finance"
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

/// Statut de phase (Machine à état pour Compliance Gates)
enum PhaseStatus {
  BROUILLON
  EN_ATTENTE_VALIDATION
  ADMIS
  CONTRACTUALISE
  ACTIF
  EN_COURS
  SUSPENDU
  TERMINE
  CLOTURE
  FACTURE
  ABANDONNE
}

/// Type de financeur (L.6353-1)
enum TypeFinanceur {
  CPF
  OPCO
  ENTREPRISE
  PERSONNEL
  MIXTE
}

/// Type de contrat
enum TypeContrat {
  CONVENTION
  CONTRAT
}

/// Type de preuve (Documents Qualiopi)
enum TypePreuve {
  PROGRAMME
  CGV
  TEST_POSITIONNEMENT
  ANALYSE_BESOIN
  CONTRAT_SIGNE
  ACCORD_FINANCEMENT
  EMARGEMENT
  RELEVE_CONNEXION
  TRAVAUX_STAGIAIRE
  CERTIFICAT_REALISATION
  EVALUATION_CHAUD
  FACTURE
  AVENANT
  JUSTIFICATIF_ABSENCE
}

/// Motif d'abandon (Machine à état Phase 4)
enum MotifAbandon {
  FORCE_MAJEURE
  VOLONTAIRE
  EXCLUSION
  DEFAUT_PAIEMENT
}

/// Statut certification RNCP/RS
enum StatutCertification {
  ACTIVE
  INACTIVE
  EN_COURS
}

/// Modalité de formation
enum Modalite {
  PRESENTIEL
  FOAD
  MIXTE
}

/// Niveau d'action pour AuditLog
enum NiveauAction {
  LECTURE
  CREATION
  EDITION
  VALIDATION
  SUPPRESSION
  FORCAGE
}

/// Type de template de document juridique
enum DocumentTemplateType {
  CONTRACT // Contrat de partenariat
  DPA      // Data Processing Agreement (RGPD)
  CGV      // Conditions Générales de Vente API
}

/// Scope d'accès aux sites dans une organisation
enum MembershipScope {
  GLOBAL
  RESTRICTED
}

/// Type d'organisme de formation (SaaS Multi-Tenant)
enum OrganizationType {
  OF_STANDARD
  CFA
  BILAN
  VAE
}

enum CandidateActivityType {
  STATUS_CHANGE
  QUALIFICATION_SCORE
  EMAIL_SENT
  NOTE_ADDED
  DOCUMENT_UPLOADED
  SYSTEM_ALERT
  DOSSIER_UPDATE
  OTHER
}

enum CandidateStatus {
  NEW
  CONTACTED
  DIP_SENT
  DIP_SIGNED
  CONTRACT_SENT
  SIGNED
  REJECTED
  WITHDRAWN
}

enum DossierSource {
  ORGANIC
  NETWORK_DISPATCH
}

enum FranchiseType {
  OF
  CFA
}

enum LeadSource {
  FACEBOOK_ADS
  TIKTOK_ADS
  GOOGLE_ADS
  LINKEDIN_ADS
  WEBSITE_FORM
  PARTNER_API
  MANUAL
  CAMPAIGN
  REFERRAL
  EVENT
  OTHER
}

enum LeadStatus {
  NEW             // Nouveau, non traité
  DISPATCHED      // [NEW] Affecté à une agence (Site)
  ATTEMPTED       // [NEW] Tentative d'appel (NRP)
  CONTACTED       // Contact établi
  QUALIFIED       // Pré-qualifié (Intérêt confirmé)
  RDV_SCHEDULED   // [NEW] RDV Physique programmé (Objectif final Prospection)
  NEGOTIATION     // En discussion (Post-RDV)
  CONVERTED       // Dossier créé (Gagné)
  NOT_ELIGIBLE    // [NEW] Pas éligible / Pas intéressé (Perdu)
  NURTURING       // [NEW] A recontacter plus tard
  LOST            // Perdu (Plus de réponse, etc.)
  ARCHIVED        // Archivé
}

enum NetworkType {
  HEAD_OFFICE
  FRANCHISE
  SUCCURSALE
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}
