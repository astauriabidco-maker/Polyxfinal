generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Organisation (OF/CFA) - Tenant principal pour l'isolation des données
model Organization {
  id                    String               @id @default(cuid())
  name                  String
  siret                 String               @unique
  type                  OrganizationType     @default(OF_STANDARD)
  ndaNumber             String?
  qualiopiCertified     Boolean              @default(false)
  qualiopiExpiry        DateTime?
  logoUrl               String?
  isActive              Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  cachetUrl             String?
  cgvUrl                String?
  leadFeeRate           Float?
  livretAccueilUrl      String?
  networkType           NetworkType?
  parentId              String?
  reglementInterieurUrl String?
  responsableName       String?
  royaltyRate           Float?
  signatureUrl          String?
  auditLogs             AuditLog[]
  campaigns             Campaign[]
  certifications        Certification[]
  companies             Company[]
  documentTemplates    DocumentTemplate[]
  dossiers              Dossier[]
  financeurs            Financeur[]
  franchiseCandidates   FranchiseCandidate[]
  leads                 Lead[]
  members               Membership[]
  networkSettings       NetworkSettings?
  parent                Organization?        @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children              Organization[]       @relation("OrganizationHierarchy")
  partners              Partner[]
  preuves               Preuve[]
  programmes            Programme[]
  reclamations          Reclamation[]
  sessions              Session[]
  sites                 Site[]
  territories           Territory[]
  roles                 Role[]
  zoneMappings          ZoneMapping[]
  prequalScripts        PrequalScript[]
  messagingConfig       MessagingConfig?
  messages              Message[]
  automations           MessageAutomation[]
  scheduledMessages     ScheduledMessage[]
  sequences             MessageSequence[]
  broadcasts            Broadcast[]
  contactTags           ContactTag[]
  chatbotRules          ChatbotRule[]
  interactiveActions    InteractiveAction[]
  aiSettings            AISettings?
  
  @@index([siret])
  @@index([type])
  @@index([isActive])
  @@index([networkType])
  @@index([parentId])
}

/// Site / Campus (Lieu d'exécution de formation)
model Site {
  id                   String                 @id @default(cuid())
  organizationId       String
  name                 String
  isHeadquarters       Boolean                @default(false)
  address              String?
  city                 String
  zipCode              String
  uaiCode              String?
  siretNic             String?
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  dossiers             Dossier[]
  membershipSiteAccess MembershipSiteAccess[]
  sessions             Session[]
  organization         Organization           @relation(fields: [organizationId], references: [id])
  leads                Lead[]
  zoneMappings         ZoneMapping[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([uaiCode])
  @@index([isActive])
}

/// Entreprise cliente (B2B / Employeur pour CFA)
model Company {
  id               String       @id @default(cuid())
  organizationId   String
  raisonSociale    String
  siret            String
  contactNom       String?
  contactEmail     String?
  contactTelephone String?
  adresse          String?
  codePostal       String?
  ville            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id])
  dossiers         Dossier[]

  @@unique([organizationId, siret])
  @@index([organizationId])
}

/// Utilisateur (agnostique - peut appartenir à plusieurs organisations)
model User {
  id                String        @id @default(cuid())
  email             String        @unique
  emailVerified     DateTime?
  passwordHash      String?
  nom               String
  prenom            String
  telephone         String?
  isActive          Boolean       @default(true)
  mustChangePassword Boolean      @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  auditLogs         AuditLog[]
  dossiersCreated   Dossier[]     @relation("DossierCreatedBy")
  memberships       Membership[]
  reclamationsOwned Reclamation[] @relation("ReclamationOwner")
  sessionsFormateur Session[]     @relation("SessionFormateur")
  validationsGiven  Validation[]
  preuvesGenerated  Preuve[]      @relation("PreuveGenerePar")
  assignedLeads     Lead[]        @relation("LeadAssignedTo")
  callLogs          CallLog[]
  messagesSent      Message[]     @relation("MessageSentBy")

  @@index([email])
}

/// Membership (relation User <-> Organization avec rôle et scope site)
model Membership {
  userId         String
  organizationId String
  roleId         String                 // Changed from role enum to roleId
  scope          MembershipScope        @default(GLOBAL)
  lastAccessedAt DateTime               @default(now())
  isActive       Boolean                @default(true)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           Role                   @relation(fields: [roleId], references: [id])
  siteAccess     MembershipSiteAccess[]

  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

/// Table de liaison Membership <-> Site (pour scope RESTRICTED)
model MembershipSiteAccess {
  membershipUserId String
  membershipOrgId  String
  siteId           String
  membership       Membership @relation(fields: [membershipUserId, membershipOrgId], references: [userId, organizationId], onDelete: Cascade)
  site             Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@id([membershipUserId, membershipOrgId, siteId])
  @@index([siteId])
}

/// Certification RNCP/RS (Check API France Compétences)
model Certification {
  id              String              @id @default(cuid())
  code            String
  intitule        String
  statut          StatutCertification @default(ACTIVE)
  dateFinValidite DateTime?
  urlFicheFC      String?
  lastCheckedAt   DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  organizationId  String
  organization    Organization        @relation(fields: [organizationId], references: [id])
  programmes      Programme[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([statut])
}

/// Programme de formation (Versionné)
model Programme {
  id                 String              @id @default(cuid())
  reference          String
  title              String              @map("intitule") // Mapped to existing column to preserve data
  publicCible        String?             @db.Text
  prerequis          String              @db.Text
  objectifs          String[]            // Changed from String to String[] for granular objectives
  contenu            Json?               // Changed from String to Json for structured content
  modalitesEval      String?             // Made optional as we might move to structured data
  moyensPedago       String?
  accessibilitePSH   String?
  dureeHeures        Int
  dureeJours         Float               @default(0)
  modalite           Modalite            @default(PRESENTIEL)
  tarifHT            Decimal?            @db.Decimal(10, 2) // Kept for backward compatibility
  tarifTTC           Decimal?            @db.Decimal(10, 2) // Kept for backward compatibility
  tarifInter         Float?
  tarifIntra         Float?
  
  // Franchise & Network Logic
  isTemplate         Boolean             @default(false)
  originalTemplateId String?
  originalTemplate   Programme?          @relation("ProgramInheritance", fields: [originalTemplateId], references: [id])
  copies             Programme[]         @relation("ProgramInheritance")

  certificationId    String?
  version            Int                 @default(1)
  isPublished        Boolean             @default(false)
  publishedAt        DateTime?
  status             PhaseStatus         @default(BROUILLON)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organizationId     String
  
  preuves            Preuve[]
  certification      Certification?      @relation(fields: [certificationId], references: [id])
  organization       Organization        @relation(fields: [organizationId], references: [id])
  snapshots          ProgrammeSnapshot[]
  sessions           Session[]

  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([status, isPublished])
  @@index([isTemplate])
  @@index([originalTemplateId])
}

/// Snapshot immuable du programme (lié au contrat signé)
model ProgrammeSnapshot {
  id              String    @id @default(cuid())
  programmeId     String
  version         Int
  contenuSnapshot Json
  createdAt       DateTime  @default(now())
  contrats        Contrat[]
  programme       Programme @relation(fields: [programmeId], references: [id])

  @@unique([programmeId, version])
  @@index([programmeId])
}

model Session {
  id             String        @id @default(cuid())
  programmeId    String
  reference      String
  dateDebut      DateTime
  dateFin        DateTime
  lieuFormation  String?
  placesMin      Int           @default(1)
  placesMax      Int
  planningJson   Json?
  formateurId    String?
  status         SessionStatus @default(PLANIFIE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  siteId         String
  dossiers       Dossier[]
  emargements    Emargement[]
  formateur      User?         @relation("SessionFormateur", fields: [formateurId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id])
  programme      Programme     @relation(fields: [programmeId], references: [id])
  site           Site          @relation(fields: [siteId], references: [id])

  @@unique([organizationId, reference])
  @@index([organizationId])
  @@index([siteId])
  @@index([programmeId])
  @@index([dateDebut, dateFin])
  @@index([status])
  @@index([formateurId])
}

/// Dossier stagiaire (Inscription à une session)
model Dossier {
  id                         String            @id @default(cuid())
  sessionId                  String
  stagiaireNom               String
  stagiairePrenom            String
  stagiaireEmail             String
  stagiaireTelephone         String?
  stagiaireAdresse           String?
  testPositionnementEnvoye   Boolean           @default(false)
  testPositionnementComplete Boolean           @default(false)
  scorePositionnement        Int?
  seuilScoreMinimum          Int               @default(50)
  alertePedagogiqueActive    Boolean           @default(false)
  declarationPSH             Boolean?
  adaptationsPSH             String?
  adaptationsPSHValidees     Boolean           @default(false)
  phaseActuelle              Int               @default(2)
  status                     PhaseStatus       @default(BROUILLON)
  dateInscription            DateTime          @default(now())
  dateValidationAdmission    DateTime?
  dateDebutEffectif          DateTime?
  dateFinEffective           DateTime?
  isAbandonne                Boolean           @default(false)
  motifAbandon               MotifAbandon?
  dateAbandon                DateTime?
  abandonValidePedago        Boolean           @default(false)
  abandonValideAdmin         Boolean           @default(false)
  tauxAssiduite              Decimal           @default(0) @db.Decimal(5, 2)
  certificatGenere           Boolean           @default(false)
  dateCertificat             DateTime?
  factureGeneree             Boolean           @default(false)
  dateFacture                DateTime?
  createdById                String
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  companyId                  String?
  organizationId             String
  tutorName                  String?
  siteId                     String
  dispatchedAt               DateTime?
  dispatchedFromId           String?
  originalLeadDate           DateTime?
  source                     DossierSource     @default(ORGANIC)
  stagiaireCp                String?
  complianceAlerts           ComplianceAlert[]
  contrats                   Contrat[]
  company                    Company?          @relation(fields: [companyId], references: [id])
  createdBy                  User              @relation("DossierCreatedBy", fields: [createdById], references: [id])
  organization               Organization      @relation(fields: [organizationId], references: [id])
  session                    Session           @relation(fields: [sessionId], references: [id])
  site                       Site              @relation(fields: [siteId], references: [id])
  emargements                Emargement[]
  evaluations                Evaluation[]
  preuves                    Preuve[]
  messages                   Message[]

  @@index([organizationId])
  @@index([siteId])
  @@index([sessionId])
  @@index([companyId])
  @@index([stagiaireEmail])
  interactiveActions             InteractiveAction[]

  @@index([status, phaseActuelle])
  @@index([source])
}

/// Financeur
model Financeur {
  id               String        @id @default(cuid())
  type             TypeFinanceur
  raisonSociale    String?
  siret            String?
  codeOPCO         String?
  numeroCPF        String?
  soldeCPF         Decimal?      @db.Decimal(10, 2)
  contactNom       String?
  contactEmail     String?
  contactTelephone String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  organizationId   String
  contrats         Contrat[]
  organization     Organization  @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([siret])
}

/// Contrat ou Convention
model Contrat {
  id                      String            @id @default(cuid())
  dossierId               String
  type                    TypeContrat
  programmeSnapshotId     String
  financeurId             String
  montantHT               Decimal           @db.Decimal(10, 2)
  montantTVA              Decimal           @db.Decimal(10, 2)
  montantTTC              Decimal           @db.Decimal(10, 2)
  dateSignature           DateTime?
  dateDebutPrevue         DateTime
  dateFinPrevue           DateTime
  delaiRetractationJours  Int?
  dateFinRetractation     DateTime?
  retractationRespectee   Boolean           @default(false)
  accordFinancementRecu   Boolean           @default(false)
  dateAccordFinancement   DateTime?
  referenceAccord         String?
  isSigned                Boolean           @default(false)
  status                  PhaseStatus       @default(BROUILLON)
  mentionsLegalesIncluses Boolean           @default(true)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  avenants                Avenant[]
  dossier                 Dossier           @relation(fields: [dossierId], references: [id])
  financeur               Financeur         @relation(fields: [financeurId], references: [id])
  programmeSnapshot       ProgrammeSnapshot @relation(fields: [programmeSnapshotId], references: [id])
  preuves                 Preuve[]

  @@index([dossierId])
  @@index([financeurId])
  @@index([status])
}

/// Avenant (Modification après signature - Tracée)
model Avenant {
  id             String   @id @default(cuid())
  contratId      String
  motif          String
  ancienneValeur Json
  nouvelleValeur Json
  validePar      String
  dateValidation DateTime @default(now())
  createdAt      DateTime @default(now())
  contrat        Contrat  @relation(fields: [contratId], references: [id])

  @@index([contratId])
}

/// Émargement (Suivi assiduité par demi-journée)
model Emargement {
  id                 String    @id @default(cuid())
  sessionId          String
  dossierId          String
  dateEmargement     DateTime
  demiJournee        String
  estPresent         Boolean   @default(false)
  signatureStagiaire String?
  signatureFormateur String?
  absenceJustifiee   Boolean   @default(false)
  motifAbsence       String?
  justificatifPath   String?
  justificatifValide Boolean   @default(false)
  isFOAD             Boolean   @default(false)
  tempsConnexion     Int?
  jalonAtteint       Boolean   @default(false)
  dateOriginale      DateTime?
  isForced           Boolean   @default(false)
  forcedById         String?
  forcedReason       String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  dossier            Dossier   @relation(fields: [dossierId], references: [id])
  session            Session   @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, dossierId, dateEmargement, demiJournee])
  @@index([sessionId])
  @@index([dossierId])
  @@index([dateEmargement])
}

/// Alerte décrochage
model AlerteDecrochage {
  id             String    @id @default(cuid())
  dossierId      String
  sessionId      String
  type           String
  description    String
  isTraitee      Boolean   @default(false)
  dateTraitement DateTime?
  actionPrise    String?
  traiteParId    String?
  createdAt      DateTime  @default(now())

  @@index([dossierId])
  @@index([isTraitee])
}

/// Évaluation (Résultats et évaluations à chaud)
model Evaluation {
  id           String   @id @default(cuid())
  dossierId    String
  type         String
  score        Int?
  commentaires String?
  reponses     Json?
  saisiPar     String
  dateSaisie   DateTime @default(now())
  dossier      Dossier  @relation(fields: [dossierId], references: [id])

  @@index([dossierId])
  @@index([type])
}

/// Preuve (Documents générés - Qualiopi)
model Preuve {
  id             String       @id @default(cuid())
  type           TypePreuve
  dossierId      String?
  organizationId String
  programmeId    String?
  contratId      String?
  nomFichier     String
  cheminFichier  String
  mimeType       String
  tailleFichier  Int
  hashFichier    String
  isSigned       Boolean      @default(false)
  signatureId    String?
  dateGeneration DateTime     @default(now())
  genereParId    String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  generePar      User         @relation("PreuveGenerePar", fields: [genereParId], references: [id])
  dossier        Dossier?     @relation(fields: [dossierId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  programme      Programme?   @relation(fields: [programmeId], references: [id])
  contrat        Contrat?     @relation(fields: [contratId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([dossierId])
  @@index([contratId])
}

/// Réclamation
model Reclamation {
  id                 String       @id @default(cuid())
  demandeurType      String
  demandeurNom       String
  demandeurEmail     String
  objet              String
  description        String
  ownerId            String?
  status             PhaseStatus  @default(BROUILLON)
  dateResolution     DateTime?
  actionsCorrectives String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id])
  owner              User?        @relation("ReclamationOwner", fields: [ownerId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([ownerId])
}

/// Validation (Trace des Compliance Gates)
model Validation {
  id             String   @id @default(cuid())
  action         String
  entityType     String
  entityId       String
  phase          Int
  validateurId   String
  roleValidateur String       // Snapshot of role code
  decision       String
  motif          String?
  createdAt      DateTime @default(now())
  validateur     User     @relation(fields: [validateurId], references: [id])

  @@index([entityType, entityId])
  @@index([validateurId])
  @@index([phase])
}

/// @Compliance: Stocke les blocages levés par le Moteur de Règles JSON
/// Chaque alerte référence un ruleId du fichier compliance_rules.json
model ComplianceAlert {
  id           String    @id @default(cuid())
  dossierId    String
  ruleId       String
  severity     String
  context      String
  trigger      String
  message      String
  details      Json?
  isResolved   Boolean   @default(false)
  resolvedById String?
  resolvedAt   DateTime?
  resolution   String?
  createdAt    DateTime  @default(now())
  dossier      Dossier   @relation(fields: [dossierId], references: [id])

  @@index([dossierId])
  @@index([ruleId])
  @@index([isResolved])
  @@index([severity])
}

/// Log d'audit immuable - AUCUN UPDATE/DELETE AUTORISÉ
model AuditLog {
  id             String       @id @default(cuid())
  timestamp      DateTime     @default(now())
  userId         String
  userRole       String       // Snapshot of role name/code at time of action
  action         String
  niveauAction   NiveauAction
  entityType     String
  entityId       String
  phase          Int?
  isForced       Boolean      @default(false)
  justification  String?
  previousState  Json?
  newState       Json?
  ipAddress      String?
  userAgent      String?
  requestId      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@index([phase])
}

model Campaign {
  id                  String               @id @default(cuid())
  organizationId      String
  name                String
  source              LeadSource
  externalId          String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  budget              Decimal?             @db.Decimal(10, 2)
  spent               Decimal?             @db.Decimal(10, 2)
  startDate           DateTime?
  endDate             DateTime?
  isActive            Boolean              @default(true)
  webhookSecret       String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  organization        Organization         @relation(fields: [organizationId], references: [id])
  leads               Lead[]
  franchiseCandidates FranchiseCandidate[]

  @@unique([organizationId, externalId])
  @@index([isActive])
  @@index([organizationId])
  @@index([source])
}

model CandidateActivity {
  id          String                @id @default(cuid())
  candidateId String
  type        CandidateActivityType
  description String
  metadata    Json?
  performedBy String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  candidate   FranchiseCandidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([createdAt(sort: Desc)])
  @@index([type])
}

model FranchiseCandidate {
  id                   String              @id @default(cuid())
  organizationId       String
  email                String
  phone                String?
  status               CandidateStatus     @default(NEW)
  targetZone           String?
  targetZipCodes       String[]
  investmentBudget     Decimal?            @db.Decimal(12, 2)
  dipSentAt            DateTime?
  dipSignedAt          DateTime?
  contractSignedAt     DateTime?
  createdOrgId         String?
  notes                String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  campaignId           String?
  companyName          String
  experienceScore      Int?
  financialScore       Int?
  franchiseType        FranchiseType
  geoScore             Int?
  leadSource           LeadSource          @default(WEBSITE_FORM)
  motivationIndex      Int?
  qualificationAnswers Json?
  qualificationScore   Int?
  qualifiedAt          DateTime?
  representantFonction String?
  representantNom      String
  representantPrenom   String
  siret                String?
  structureScore       Int?
  timingScore          Int?
  utmCampaign          String?
  utmMedium            String?
  utmSource            String?
  name                 String?
  activities           CandidateActivity[]
  organization         Organization        @relation(fields: [organizationId], references: [id])
  campaign             Campaign?           @relation(fields: [campaignId], references: [id])

  @@index([email])
  @@index([franchiseType])
  @@index([leadSource])
  @@index([organizationId])
  @@index([qualificationScore])
  @@index([status])
}

model Lead {
  id                 String       @id @default(cuid())
  organizationId     String
  siteId             String?      // Dispatch: Agence/Campus responsable
  source             LeadSource
  sourceRef          String?
  campaignId         String?
  partnerId          String?
  origin             String?      // Précision sur l'origine (ex: "Salon étudiant", "Formulaire Contact")
  email              String
  nom                String
  prenom             String
  telephone          String?
  adresse            String?          // Rue / numéro de rue
  codePostal         String?
  ville              String?
  formationSouhaitee String?
  message            String?
  dateReponse        DateTime?        // Date de réponse du lead
  dateRdv            DateTime?        // Date du RDV physique confirmé
  nextCallDate       DateTime?        // Date de prochain rappel
  lostReason         String?          // Raison de perte (si PERDU)
  metadata           Json?
  status             LeadStatus   @default(NEW)
  score              Int?
  notes              String?
  assignedToId       String?
  convertedAt        DateTime?
  convertedDossierId String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  assignedTo         User?        @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  campaign           Campaign?    @relation(fields: [campaignId], references: [id])
  organization       Organization @relation(fields: [organizationId], references: [id])
  site               Site?        @relation(fields: [siteId], references: [id])
  partner            Partner?     @relation(fields: [partnerId], references: [id])
  leadConsent        LeadConsent?

  @@index([assignedToId])
  @@index([campaignId])
  @@index([createdAt])
  @@index([email])
  @@index([organizationId])
  @@index([siteId])
  @@index([partnerId])
  @@index([source])
  @@index([status])
  callLogs           CallLog[]
  messages           Message[]
  contactTags        ContactTag[]
}

model LeadConsent {
  id            String    @id @default(cuid())
  leadId        String    @unique
  consentGiven  Boolean   @default(false)
  consentText   String
  consentMethod String
  legalBasis    String
  withdrawnAt   DateTime?
  anonymizedAt  DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([consentGiven])
  @@index([leadId])
}

model NetworkSettings {
  id                       String       @id @default(cuid())
  organizationId           String       @unique
  onboardingEmailSubject   String       @default("Signature de vos contrats de partenariat - Polyx ERP")
  onboardingEmailBody      String       @db.Text
  activationEmailSubject   String       @default("Activation de votre accès API - Polyx ERP")
  activationEmailBody      String       @db.Text
  apiDocumentationMarkdown String       @db.Text
  doubinDelayDays          Int          @default(20)
  updatedAt                DateTime     @updatedAt
  organization             Organization @relation(fields: [organizationId], references: [id])
}

/// Templates de documents juridiques configurables par organisme
model DocumentTemplate {
  id             String               @id @default(cuid())
  organizationId String
  type           DocumentTemplateType // CONTRACT, DPA, CGV
  title          String               // Titre du document (ex: "Contrat de Partenariat API")
  version        Int                  @default(1) // Numéro de version
  isActive       Boolean              @default(true) // Seul le template actif est utilisé
  sections       Json                 // Sections du document [{title, content}]
  variables      Json?                // Métadonnées sur les variables disponibles
  footerText     String?              @db.Text // Texte de pied de page
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  createdBy      String?              // userId de l'auteur

  organization   Organization         @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, type, version])
  @@index([organizationId, type, isActive])
}

model Partner {
  id             String @id @default(cuid())
  organizationId String

  // ─── Identification personne morale ─────────────────────
  companyName    String // Raison sociale
  formeJuridique String? // SAS, SARL, EURL, SA, SCI, Auto-entrepreneur...
  capitalSocial  Decimal? @db.Decimal(12, 2) // Capital social en euros
  siret          String? // SIRET 14 chiffres
  siren          String? // SIREN 9 chiffres (déduit du SIRET)
  codeNAF        String? // Code APE/NAF
  rcs            String? // RCS (ex: "RCS Paris B 123 456 789")
  tvaIntracom    String? // N° TVA intracommunautaire

  // ─── Adresse du siège social ────────────────────────────
  adresse           String? // Numéro et rue
  complementAdresse String? // Bâtiment, étage, etc.
  codePostal        String? // Code postal
  ville             String? // Ville
  pays              String  @default("France") // Pays

  // ─── Représentant légal ─────────────────────────────────
  representantNom      String? // Nom complet du représentant légal
  representantFonction String? // Fonction (Gérant, Président, DG...)

  // ─── Contact opérationnel (technique / leads) ───────────
  contactName  String // Nom du contact opérationnel
  contactEmail String // Email du contact
  contactPhone String? // Téléphone du contact

  // ─── Coordonnées bancaires (pour facturation) ──────────
  iban String? // IBAN
  bic  String? // BIC / SWIFT

  // ─── API & Technique ────────────────────────────────────
  apiKeyHash   String?  @unique // SHA-256 hash de la clé API (null tant que non activé)
  apiKeyPrefix String? // Préfixe visible (pk_live_xxxx...) (null tant que non activé)
  rateLimit    Int      @default(100) // Requêtes max / heure
  webhookUrl   String? // URL callback pour notifications
  ipWhitelist  String[] // IPs autorisées (vide = toutes)

  // ─── Contrat & Conformité ──────────────────────────────
  contractUrl       String? // URL du contrat signé
  contractSignedAt  DateTime? // Date signature contrat
  contractExpiresAt DateTime? // Date expiration contrat
  dpaSignedAt       DateTime? // Date signature DPA (RGPD)
  ndaSignedAt       DateTime? // Date signature NDA
  commissionRate    Decimal?  @db.Decimal(5, 2) // Taux commission (si applicable)
  costPerLead       Decimal?  @db.Decimal(8, 2) // Coût fixe par lead soumis (€)
  notes             String?   @db.Text // Notes internes

  // ─── Statut & Métriques ─────────────────────────────────
  status              PartnerStatus @default(PENDING)
  totalLeadsSubmitted Int           @default(0)
  totalLeadsConverted Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // ─── Relations ──────────────────────────────────────────
  leads          Lead[]
  auditLogs      PartnerAuditLog[]
  qualification  PartnerQualification?
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([apiKeyHash])
  @@index([organizationId])
  @@index([status])
  @@index([siret])
}

/// Journal d'audit des actions partenaires (Qualiopi Ind.17/26 + RGPD Art.5)
model PartnerAuditLog {
  id             String   @id @default(cuid())
  partnerId      String
  organizationId String
  action         String   // CREATED, ACTIVATED, SUSPENDED, CONTRACT_SIGNED, DPA_SIGNED, 
                          // NDA_SIGNED, API_KEY_GENERATED, API_KEY_REVOKED, RATE_LIMIT_CHANGED,
                          // CONTRACT_EXPIRED, STATUS_CHANGED, UPDATED, DELETED, LEAD_REJECTED_COMPLIANCE
  performedBy    String?  // userId de l'admin qui a effectué l'action (null = système)
  performedByName String? // Nom lisible de l'acteur
  details        String?  @db.Text // Description détaillée de l'action
  previousValue  Json?    // Snapshot avant modification
  newValue       Json?    // Snapshot après modification
  ipAddress      String?  // IP de l'admin
  userAgent      String?  // User-Agent de l'admin
  createdAt      DateTime @default(now())

  partner        Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

/// Qualification partenaire — Qualiopi Ind. 17 (sous-traitance) & Ind. 26 (intervenants externes)
/// Trace la convention de sous-traitance, la qualification du partenaire et le contrôle qualité.
model PartnerQualification {
  id             String @id @default(cuid())
  partnerId      String @unique
  organizationId String

  // ─── Convention de sous-traitance (Ind. 17) ────────────
  conventionSignedAt  DateTime?  // Date signature convention de sous-traitance
  conventionUrl       String?    // URL du document signé
  conventionExpiresAt DateTime?  // Date expiration convention
  conventionType      String     @default("PROSPECTION") // PROSPECTION, FORMATION, MIXTE

  // ─── Dossier de compétences (Ind. 26) ──────────────────
  hasKbis             Boolean @default(false) // Extrait K-Bis à jour
  hasRcPro            Boolean @default(false) // Assurance RC Professionnelle
  hasUrssaf           Boolean @default(false) // Attestation URSSAF < 6 mois
  hasReferences       Boolean @default(false) // Références clients fournies
  hasCertifications   Boolean @default(false) // Certifications/agréments
  hasQualityCharter   Boolean @default(false) // Charte qualité signée

  // ─── Champs textuels pour détails ──────────────────────
  certificationDetails String?  @db.Text // Détail des certifications (Qualiopi, ISO, etc.)
  referencesDetails    String?  @db.Text // Détail des références fournies
  rcProPolicyNumber    String?           // N° de police RC Pro
  rcProExpiresAt       DateTime?         // Expiration RC Pro
  urssafDate           DateTime?         // Date attestation URSSAF
  kbisDate             DateTime?         // Date extrait K-Bis

  // ─── Score & Évaluation ────────────────────────────────
  qualificationScore   Int      @default(0)  // Score 0-100 calculé
  qualificationGrade   String   @default("D") // A, B, C, D
  isQualified          Boolean  @default(false) // Score >= seuil minimum (60)
  lastEvaluationAt     DateTime?             // Date dernière évaluation
  nextReviewAt         DateTime?             // Date prochaine revue programmée
  evaluatedBy          String?               // Nom de l'évaluateur
  evaluationNotes      String?  @db.Text     // Notes de l'évaluation

  // ─── Timestamps ────────────────────────────────────────
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ─── Relations ─────────────────────────────────────────
  partner      Partner      @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isQualified])
  @@index([qualificationGrade])
  @@index([nextReviewAt])
}

model Territory {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  zipCodes       String[]
  isExclusive    Boolean      @default(true)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([isActive])
  @@index([organizationId])
}

/// Rôles système RBAC (5 rôles définis dans rbac_matrix.md)
/// Role (Système RBAC Dynamique)
model Role {
  id             String           @id @default(cuid())
  name           String           // ex: "Responsable Pédagogique"
  code           String           // ex: "RESP_PEDAGO"
  description    String?
  isSystem       Boolean          @default(false)
  organizationId String?          // Null = Global System Role, Value = Custom Org Role
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  permissions    RolePermission[]
  memberships    Membership[]

  organization   Organization?    @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@unique([organizationId, code])
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique // ex: "org:read", "dossier:create"
  description String
  category    String?          // ex: "Dossiers", "Finance"
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

/// Statut de phase (Machine à état pour Compliance Gates)
enum PhaseStatus {
  BROUILLON
  EN_ATTENTE_VALIDATION
  ADMIS
  CONTRACTUALISE
  ACTIF
  EN_COURS
  SUSPENDU
  TERMINE
  CLOTURE
  FACTURE
  ABANDONNE
}

/// Type de financeur (L.6353-1)
enum TypeFinanceur {
  CPF
  OPCO
  ENTREPRISE
  PERSONNEL
  MIXTE
}

/// Type de contrat
enum TypeContrat {
  CONVENTION
  CONTRAT
}

/// Type de preuve (Documents Qualiopi)
enum TypePreuve {
  PROGRAMME
  CGV
  TEST_POSITIONNEMENT
  ANALYSE_BESOIN
  CONTRAT_SIGNE
  ACCORD_FINANCEMENT
  EMARGEMENT
  RELEVE_CONNEXION
  TRAVAUX_STAGIAIRE
  CERTIFICAT_REALISATION
  EVALUATION_CHAUD
  FACTURE
  AVENANT
  JUSTIFICATIF_ABSENCE
}

/// Motif d'abandon (Machine à état Phase 4)
enum MotifAbandon {
  FORCE_MAJEURE
  VOLONTAIRE
  EXCLUSION
  DEFAUT_PAIEMENT
}

/// Statut certification RNCP/RS
enum StatutCertification {
  ACTIVE
  INACTIVE
  EN_COURS
}

/// Modalité de formation
enum Modalite {
  PRESENTIEL
  DISTANCIEL // Was FOAD
  BLENDED    // Was MIXTE
  AFEST
}

/// Niveau d'action pour AuditLog
enum NiveauAction {
  LECTURE
  CREATION
  EDITION
  VALIDATION
  SUPPRESSION
  FORCAGE
}

/// Type de template de document juridique
enum DocumentTemplateType {
  CONTRACT // Contrat de partenariat
  DPA      // Data Processing Agreement (RGPD)
  CGV      // Conditions Générales de Vente API
}

/// Scope d'accès aux sites dans une organisation
enum MembershipScope {
  GLOBAL
  RESTRICTED
}

/// Type d'organisme de formation (SaaS Multi-Tenant)
enum OrganizationType {
  OF_STANDARD
  CFA
  BILAN
  VAE
}

enum CandidateActivityType {
  STATUS_CHANGE
  QUALIFICATION_SCORE
  EMAIL_SENT
  NOTE_ADDED
  DOCUMENT_UPLOADED
  SYSTEM_ALERT
  DOSSIER_UPDATE
  OTHER
}

enum CandidateStatus {
  NEW
  CONTACTED
  DIP_SENT
  DIP_SIGNED
  CONTRACT_SENT
  SIGNED
  REJECTED
  WITHDRAWN
}

enum DossierSource {
  ORGANIC
  NETWORK_DISPATCH
}

enum FranchiseType {
  OF
  CFA
}

enum LeadSource {
  FACEBOOK_ADS
  TIKTOK_ADS
  GOOGLE_ADS
  LINKEDIN_ADS
  WEBSITE_FORM
  PARTNER_API
  MANUAL
  CAMPAIGN
  REFERRAL
  EVENT
  OTHER
}

enum LeadStatus {
  // === PIPELINE (Prospection) ===
  NEW                // Nouveau, non traité
  DISPATCHED         // Affecté à une agence (auto-dispatch par CP)
  A_RAPPELER         // A rappeler (call back)
  NE_REPONDS_PAS     // Ne réponds pas (NRP)
  PAS_INTERESSE      // Pas intéressé (Perdu Pipeline)
  // === CRM (Post-RDV) ===
  RDV_PLANIFIE       // RDV fixé, en attente
  RDV_NON_HONORE     // RDV non honoré
  COURRIERS_ENVOYES  // Courriers/Documents envoyés
  COURRIERS_RECUS    // Courriers/Documents reçus
  NEGOCIATION        // En discussion
  CONVERTI           // Inscription validée → création Dossier
  PROBLEMES_SAV      // Problèmes / SAV
  PERDU              // Abandonné (avec raison)
}

enum NetworkType {
  HEAD_OFFICE
  FRANCHISE
  SUCCURSALE
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

/// Zonage : mapping Code Postal (préfixe) → Site/Agence pour le dispatch automatique des leads
model ZoneMapping {
  id              String       @id @default(cuid())
  organizationId  String
  siteId          String
  prefix          String       /// Préfixe CP : "75", "691", "13001" (longueur variable, plus long = prioritaire)
  label           String?      /// Description optionnelle : "Île-de-France", "Lyon Centre"
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id])
  site            Site         @relation(fields: [siteId], references: [id])

  @@unique([organizationId, prefix])
  @@index([organizationId, isActive])
}

/// Script de préqualification (questions admin-éditables)
model PrequalScript {
  id              String   @id @default(cuid())
  organizationId  String
  question        String
  ordre           Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, ordre])
  @@index([organizationId])
}

/// Résultat d'un appel
enum CallOutcome {
  INTERESSE
  A_RAPPELER
  NRP
  PAS_INTERESSE
}

/// Historique d'appels (log chaque tentative)
model CallLog {
  id              String      @id @default(cuid())
  leadId          String
  callerId        String      // User qui a appelé
  outcome         CallOutcome // INTERESSE, A_RAPPELER, NRP, PAS_INTERESSE
  duration        Int?        // Durée en secondes
  notes           String?
  questionsAsked  Json?       // IDs des questions cochées
  nextCallDate    DateTime?   // Si rappel planifié
  createdAt       DateTime    @default(now())

  lead            Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caller          User        @relation(fields: [callerId], references: [id])

  @@index([leadId])
  @@index([callerId])
  @@index([outcome])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════
// MESSAGING — Multi-Tenant WhatsApp / SMS Configuration
// ═══════════════════════════════════════════════════════════════

enum MessagingProviderType {
  META_CLOUD
  TWILIO
}

/// Configuration Messagerie par Organisation (Multi-Tenant)
/// Chaque tenant peut choisir Meta Cloud API ou Twilio BSP
model MessagingConfig {
  id                  String                @id @default(cuid())
  organizationId      String                @unique
  provider            MessagingProviderType @default(META_CLOUD)
  isActive            Boolean               @default(false)

  // ─── Meta Cloud API ──────────────────────────────────────
  metaPhoneNumberId   String?   // Phone Number ID from Meta
  metaBusinessId      String?   // WhatsApp Business Account ID
  metaAccessToken     String?   // Permanent token (encrypted)

  // ─── Twilio BSP ──────────────────────────────────────────
  twilioAccountSid    String?   // Account SID
  twilioAuthToken     String?   // Auth Token (encrypted)
  twilioPhoneNumber   String?   // WhatsApp-enabled number

  // ─── Common ──────────────────────────────────────────────
  defaultCountryCode  String    @default("+33")
  enabledHooks        Json?     // Admin toggles: {"DOSSIER_STATUS_CHANGE":true,"LEAD_CREATED":false,...}
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  organization        Organization      @relation(fields: [organizationId], references: [id])
  templates           MessageTemplate[]

  @@index([organizationId])
}

/// Templates de messages mappés au fournisseur
/// Ex: internalKey "RDV_CONFIRMATION" → providerName "rdv_confirm_v1" (Meta)
model MessageTemplate {
  id                  String          @id @default(cuid())
  messagingConfigId   String
  internalKey         String          // e.g. "RDV_CONFIRMATION", "NO_ANSWER"
  providerTemplateName String         // Nom du template chez le fournisseur
  language            String          @default("fr")
  fallbackText        String?         @db.Text  // Texte de fallback si template échoue
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  config              MessagingConfig @relation(fields: [messagingConfigId], references: [id], onDelete: Cascade)

  @@unique([messagingConfigId, internalKey])
  @@index([messagingConfigId])
}

// ═══════════════════════════════════════════════════════════════
// MESSAGE HISTORY — Inbox & Conversations
// ═══════════════════════════════════════════════════════════════

enum MessageDirection {
  OUTBOUND  // Envoyé depuis la plateforme
  INBOUND   // Reçu de l'apprenant
}

enum MessageChannel {
  WHATSAPP
  SMS
}

enum MessageDeliveryStatus {
  QUEUED     // En file d'attente
  SENT       // Envoyé au provider
  DELIVERED  // Délivré au destinataire
  READ       // Lu par le destinataire
  FAILED     // Échec d'envoi
}

/// Message envoyé ou reçu — historique complet des conversations
model Message {
  id                String                @id @default(cuid())
  organizationId    String
  leadId            String?               // Lien vers Lead (si identifié)
  dossierId         String?               // Lien vers Dossier (si stage en cours)

  direction         MessageDirection      // OUTBOUND | INBOUND
  channel           MessageChannel        // WHATSAPP | SMS
  status            MessageDeliveryStatus @default(SENT)

  phone             String                // Numéro normalisé (ex: 33612345678)
  content           String    @db.Text    // Contenu du message
  templateKey       String?               // Clé template si envoi template
  providerMessageId String?               // ID retourné par Meta/Twilio

  mediaUrl          String?               // URL média joint
  mediaType         String?               // MIME type (image/jpeg, application/pdf)

  sentById          String?               // User qui a envoyé (null si INBOUND)
  errorMessage      String?               // Détail erreur si FAILED
  isRead            Boolean   @default(false) // Lu par l'équipe (pour INBOUND)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organization      Organization @relation(fields: [organizationId], references: [id])
  lead              Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  dossier           Dossier?     @relation(fields: [dossierId], references: [id], onDelete: SetNull)
  sentBy            User?        @relation("MessageSentBy", fields: [sentById], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([dossierId])
  @@index([phone])
  @@index([direction])
  @@index([createdAt])
  @@index([organizationId, phone, createdAt])
}

// ═══════════════════════════════════════════════════════════════
// MESSAGING AUTOMATION — Workflows, Scheduler, Séquences
// ═══════════════════════════════════════════════════════════════

enum AutomationEvent {
  INSCRIPTION_CONFIRMED    // Dossier → ADMIS
  SESSION_J7               // 7 jours avant session.dateDebut
  SESSION_J1               // 1 jour avant session.dateDebut
  ABSENCE_DETECTED         // Emargement.estPresent = false
  MODULE_COMPLETED         // Dossier → TERMINE
  SIGNATURE_MISSING        // Emargement sans signature > 24h
  SESSION_J1_POST          // 1 jour après session.dateFin
  DOSSIER_STATUS_CHANGE    // Tout changement de statut dossier
  LEAD_CREATED             // Nouveau lead créé
  LEAD_QUALIFIED           // Lead → QUALIFIED
}

enum ScheduledMessageStatus {
  PENDING      // En attente d'envoi
  PROCESSING   // En cours d'envoi
  SENT         // Envoyé avec succès
  FAILED       // Échec après retries
  CANCELLED    // Annulé manuellement
}

enum SequenceStatus {
  ACTIVE           // En cours
  PAUSED           // Pausée
  COMPLETED        // Toutes les étapes exécutées
  STOPPED_BY_REPLY // Arrêtée car le contact a répondu
}

/// Règle d'automatisation — Event → Message
model MessageAutomation {
  id               String           @id @default(cuid())
  organizationId   String
  name             String           // Nom lisible (ex: "Rappel J-7")
  description      String?
  event            AutomationEvent  // Événement déclencheur
  isActive         Boolean          @default(true)
  channel          MessageChannel   @default(WHATSAPP)

  // Contenu du message
  templateKey      String?          // Clé template Meta (si template)
  content          String?  @db.Text // Contenu freeform (avec variables {nom}, {date}, etc.)

  // Timing
  delayMinutes     Int              @default(0) // Délai après l'événement (0 = immédiat)

  // Conditions avancées (JSON)
  conditions       String?  @db.Text // ex: {"status": "ADMIS", "formation": "CDA"}

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  scheduledMessages ScheduledMessage[]

  @@index([organizationId])
  @@index([event])
  @@index([isActive])
}

/// Message programmé dans la file d'attente
model ScheduledMessage {
  id               String                 @id @default(cuid())
  organizationId   String
  automationId     String?                // Lié à une automation (null si programmé manuellement)
  sequenceEnrollmentId String?            // Lié à une séquence (null si standalone)

  phone            String
  content          String     @db.Text
  channel          MessageChannel @default(WHATSAPP)
  templateKey      String?

  scheduledAt      DateTime               // Date/heure d'envoi prévu
  status           ScheduledMessageStatus @default(PENDING)
  retryCount       Int                    @default(0)
  maxRetries       Int                    @default(3)
  lastError        String?

  leadId           String?
  dossierId        String?
  sentById         String?
  messageId        String?                // ID du Message créé après envoi

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  automation       MessageAutomation? @relation(fields: [automationId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([status, scheduledAt])
  @@index([automationId])
  @@index([sequenceEnrollmentId])
}

/// Séquence de messages multi-étapes
model MessageSequence {
  id               String           @id @default(cuid())
  organizationId   String
  name             String           // Ex: "Onboarding J-7 → J+1"
  description      String?
  triggerEvent     AutomationEvent  // Événement qui démarre la séquence
  stopOnReply      Boolean          @default(true) // Arrêt auto si réponse
  isActive         Boolean          @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization          @relation(fields: [organizationId], references: [id])
  steps            MessageSequenceStep[]
  enrollments      SequenceEnrollment[]

  @@index([organizationId])
  @@index([triggerEvent])
  @@index([isActive])
}

/// Étape dans une séquence de messages
model MessageSequenceStep {
  id               String           @id @default(cuid())
  sequenceId       String
  stepOrder        Int              // 1, 2, 3...
  delayDays        Int              // Relatif au trigger: -7=J-7, -1=J-1, 0=Jour J, 1=J+1
  channel          MessageChannel   @default(WHATSAPP)

  // Contenu
  templateKey      String?
  content          String?  @db.Text // Message freeform avec variables

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sequence         MessageSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
}

/// Inscription d'un contact à une séquence active
model SequenceEnrollment {
  id               String           @id @default(cuid())
  sequenceId       String
  organizationId   String
  phone            String
  leadId           String?
  dossierId        String?

  status           SequenceStatus   @default(ACTIVE)
  currentStep      Int              @default(0) // Dernière étape exécutée
  nextStepAt       DateTime?        // Prochaine exécution planifiée
  referenceDate    DateTime         // Date de référence (dateDebut session, etc.)

  stoppedAt        DateTime?
  stoppedReason    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sequence         MessageSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([organizationId])
  @@index([status, nextStepAt])
  @@index([phone])
}

// ═══════════════════════════════════════════════════════════════
// BROADCAST — Envoi groupé & Segmentation
// ═══════════════════════════════════════════════════════════════

enum BroadcastStatus {
  DRAFT          // Brouillon
  SENDING        // Envoi en cours
  PAUSED         // Pausé
  COMPLETED      // Terminé
  FAILED         // Échoué
  CANCELLED      // Annulé
}

enum BroadcastRecipientStatus {
  PENDING        // En attente
  SENT           // Envoyé
  DELIVERED      // Délivré
  READ           // Lu
  FAILED         // Échoué
}

/// Campagne d'envoi groupé
model Broadcast {
  id               String           @id @default(cuid())
  organizationId   String
  name             String           // "Rappel session Mars 2026"
  description      String?
  channel          MessageChannel   @default(WHATSAPP)

  // Contenu
  templateKey      String?          // Template Meta approuvé
  content          String?  @db.Text // Freeform (si pas de template)

  // Filtres de ciblage (JSON)
  filters          String   @db.Text // {sessionId, siteId, status[], formation, tags[]}

  // Stats
  totalRecipients  Int              @default(0)
  sentCount        Int              @default(0)
  deliveredCount   Int              @default(0)
  failedCount      Int              @default(0)

  status           BroadcastStatus  @default(DRAFT)
  startedAt        DateTime?
  completedAt      DateTime?
  createdById      String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  recipients       BroadcastRecipient[]

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

/// Suivi par destinataire d'un broadcast
model BroadcastRecipient {
  id               String                    @id @default(cuid())
  broadcastId      String
  phone            String
  leadId           String?
  dossierId        String?

  status           BroadcastRecipientStatus  @default(PENDING)
  externalId       String?                   // Meta message ID
  error            String?
  sentAt           DateTime?
  deliveredAt      DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  broadcast        Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  @@index([broadcastId])
  @@index([broadcastId, status])
  @@index([phone])
}

/// Tags personnalisés pour leads (segmentation)
model ContactTag {
  id               String @id @default(cuid())
  organizationId   String
  leadId           String
  tag              String          // ex: "VIP", "formation-dev-web", "promo-2026"

  createdAt        DateTime @default(now())

  organization     Organization @relation(fields: [organizationId], references: [id])
  lead             Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([organizationId, leadId, tag])
  @@index([organizationId, tag])
  @@index([leadId])
}

// ═══════════════════════════════════════════════════════════════
// CHATBOT — Auto-réponses & Menus interactifs
// ═══════════════════════════════════════════════════════════════

enum ChatbotResponseType {
  TEXT                    // Réponse texte simple
  INTERACTIVE_BUTTONS     // Boutons (max 3)
  INTERACTIVE_LIST        // Liste à sections
  REDIRECT_HUMAN          // Redirection vers conseiller
}

/// Règle de réponse automatique
model ChatbotRule {
  id               String               @id @default(cuid())
  organizationId   String
  name             String               // "Réponse horaires"
  keywords         String               // Mots-clés séparés par virgule ("horaires,heures,ouverture")
  pattern          String?              // Regex pattern optionnel
  responseType     ChatbotResponseType  @default(TEXT)
  response         String   @db.Text    // JSON: {text, buttons[], sections[]}
  isActive         Boolean              @default(true)
  priority         Int                  @default(0)    // Plus haut = prioritaire
  isDefault        Boolean              @default(false) // Règle système non supprimable

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, isActive])
  @@index([priority])
}

/// État conversation chatbot par contact
model ChatbotConversation {
  id               String   @id @default(cuid())
  organizationId   String
  phone            String
  isHumanHandoff   Boolean  @default(false)  // Redirigé vers humain
  handoffAt        DateTime?
  lastBotReplyAt   DateTime?                 // Cooldown anti-spam
  lastMenuSent     String?                   // Dernier menu envoyé (pour contexte)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([organizationId, phone])
  @@index([organizationId])
  @@index([phone])
}

/// Action déclenchée par une réponse interactive WhatsApp
model InteractiveAction {
  id             String    @id @default(cuid())
  organizationId String
  phone          String
  dossierId      String?
  actionType     String    // CONFIRM_PRESENCE, RESCHEDULE, SELECT_SLOT, SELECT_DOCUMENT, SURVEY_RESPONSE
  actionData     Json?     // Données spécifiques (créneau choisi, note satisfaction, etc.)
  replyId        String    // ID du bouton/item cliqué
  status         String    @default("PENDING") // PENDING, APPLIED, FAILED
  errorMessage   String?
  appliedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  dossier        Dossier?     @relation(fields: [dossierId], references: [id])

  @@index([organizationId])
  @@index([dossierId])
  @@index([phone])
  @@index([actionType])
}

enum SessionStatus {
  PLANIFIE
  CONFIRME
  EN_COURS
  TERMINE
  ANNULE
}

/// Configuration IA (OpenAI, Anthropic, Mistral)
model AISettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  provider       String       @default("openai") // openai, anthropic, mistral
  model          String?      // e.g. gpt-4o, claude-3-opus
  apiKey         String?      // Stockage de la clé (Idéalement crypté en prod)
  isActive       Boolean      @default(true)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}
